#!/usr/bin/env bash

# 10-secrets.sh: Optional secret bucket auto-loader
# Loads configured secret buckets into the current shell via `dot env load`.

if [[ "${DOTFILES_SECRETS_AUTO_LOAD:-0}" != "1" ]]; then
  return 0 2>/dev/null || exit 0
fi

if ! command -v dot >/dev/null 2>&1; then
  return 0 2>/dev/null || exit 0
fi

if [[ -n "${ZSH_VERSION:-}" ]]; then
  _dot_secret_buckets=(${(s:,:)DOTFILES_SECRETS_BUCKET_NAMES})
else
  IFS=',' read -r -a _dot_secret_buckets <<<"${DOTFILES_SECRETS_BUCKET_NAMES:-}"
fi
for _bucket in "${_dot_secret_buckets[@]}"; do
  [[ -n "$_bucket" ]] || continue
  # shellcheck disable=SC2046
  eval "$(dot env load "$_bucket" 2>/dev/null || true)"
done

unset _dot_secret_buckets _bucket
