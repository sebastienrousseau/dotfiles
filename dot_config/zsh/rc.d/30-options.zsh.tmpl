# Zsh history and options
HISTFILE="${HOME}/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_SAVE_NO_DUPS
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_FIND_NO_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_REDUCE_BLANKS
setopt EXTENDED_HISTORY
setopt SHARE_HISTORY
setopt APPEND_HISTORY

setopt AUTO_CD
setopt AUTO_PUSHD
setopt PUSHD_IGNORE_DUPS
setopt PUSHD_SILENT
setopt NO_BEEP

bindkey -v
autoload -Uz up-line-or-beginning-search down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
bindkey -M viins "^[[A" up-line-or-beginning-search
bindkey -M viins "^[[B" down-line-or-beginning-search
bindkey -M viins "^P" up-line-or-beginning-search
bindkey -M viins "^N" down-line-or-beginning-search

ZSH_COMPLETIONS_DIR="${XDG_DATA_HOME:-${HOME}/.local/share}/zsh/completions"
if [[ ! -d "${ZSH_COMPLETIONS_DIR}" ]]; then
  command mkdir -p "${ZSH_COMPLETIONS_DIR}"
fi
if [[ -z ${fpath[(r)${ZSH_COMPLETIONS_DIR}]} ]]; then
  fpath=("${ZSH_COMPLETIONS_DIR}" "${fpath[@]}")
fi
if [[ -f "${HOME}/.local/bin/executable_dot_completion" ]]; then
  fpath=("${HOME}/.local/bin" "${fpath[@]}")
fi
# fnm (Fast Node Manager)
# Initialize early so Node + corepack use the expected version.
if command -v fnm >/dev/null; then
  if [[ ! -f "${ZSH_COMPLETIONS_DIR}/_fnm" ]]; then
    command fnm completions --shell zsh >| "${ZSH_COMPLETIONS_DIR}/_fnm"
  fi
  eval "$(command fnm env --use-on-cd 2>/dev/null || command fnm env 2>/dev/null)"
fi

# Lazy-load NVM (if fnm is not installed)
if ! command -v fnm >/dev/null; then
  export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
  if [[ -s "${NVM_DIR}/nvm.sh" ]]; then
    _lazy_load_nvm() {
      unfunction node npm npx nvm _lazy_load_nvm 2>/dev/null
      # shellcheck disable=SC1090
      . "${NVM_DIR}/nvm.sh"
      if [[ -s "${NVM_DIR}/bash_completion" ]]; then
        # shellcheck disable=SC1090
        . "${NVM_DIR}/bash_completion"
      fi
    }
    nvm() { _lazy_load_nvm; nvm "$@"; }
    node() { _lazy_load_nvm; command node "$@"; }
    npm() { _lazy_load_nvm; command npm "$@"; }
    npx() { _lazy_load_nvm; command npx "$@"; }
  fi
fi

# Lazy-load SDKMAN
export SDKMAN_DIR="${SDKMAN_DIR:-$HOME/.sdkman}"
if [[ -s "${SDKMAN_DIR}/bin/sdkman-init.sh" && -z "${functions[sdk]:-}" ]]; then
  _lazy_load_sdkman() {
    unfunction sdk _lazy_load_sdkman 2>/dev/null
    # shellcheck disable=SC1090
    . "${SDKMAN_DIR}/bin/sdkman-init.sh"
  }
  sdk() { _lazy_load_sdkman; sdk "$@"; }
fi
autoload -Uz compinit
if [[ -n ${ZDOTDIR}/.zcompdump(#qN.mh+24) ]]; then
  compinit
else
  compinit -C
fi

zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' special-dirs true
zstyle ':completion:*' verbose yes

autoload -Uz colors && colors
unsetopt correct_all

# fzf integration
if [ -f "${HOME}/.fzf.zsh" ]; then
  source "${HOME}/.fzf.zsh"
fi

# Explicit fzf bindings (fallback if not already set by fzf)
if command -v fzf >/dev/null; then
  bindkey -M viins -s '^T' 'fzf^M'
  bindkey -M viins -s '^R' 'fzf^M'
fi

# direnv (directory environments)
if command -v direnv >/dev/null; then
  eval "$(direnv hook zsh)"
fi
