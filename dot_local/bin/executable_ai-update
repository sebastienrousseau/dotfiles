#!/usr/bin/env bash
## AI Update â€” Euxis AI workflow updater for cross-platform environments.
##
## Updates all AI-related tools and runtimes including mise, npm globals,
## pipx tools, Ollama, and LM Studio. Auto-detects installation methods.
##
## # Requirements
## - curl: For downloading updates
## - sudo: For system-level updates (Linux)
## - zstd: For Ollama archive extraction (Linux)
##
## # Usage
## ai-update                   # Update all AI tools
##
## # Platform Notes
## - macOS: Updates via Homebrew where applicable
## - Linux: Updates via APT, manual binaries, or pipx
## - WSL: Full Linux support

set -euo pipefail

# --- Configuration & Theme ---
CYAN='\033[38;5;86m'
PURPLE='\033[38;5;141m'
GREEN='\033[38;5;84m'
YELLOW='\033[38;5;227m'
RED='\033[38;5;203m'
GRAY='\033[38;5;244m'
NC='\033[0m'
BOLD='\033[1m'

# --- UI Components ---
log_header() {
    echo -e "\n${BOLD}${PURPLE}Updating AI Environment${NC}"
    echo -e "${GRAY}-----------------------------------------------------------${NC}"
}

step() { echo -ne "${CYAN}->${NC} ${BOLD}$1...${NC} "; }
ok() { echo -e "${GREEN}done${NC}"; }
skip() { echo -e "${YELLOW}skipped${NC} ${GRAY}($1)${NC}"; }
err() { echo -e "${RED}error${NC}\n   ${RED}$1${NC}"; }

# --- Initialization ---
log_header

# Pre-auth sudo to avoid mid-script interruptions
if [[ "$(uname -s)" == "Linux" ]]; then
    step "Authenticating sudo"
    sudo -v && ok || { err "Sudo required for system updates"; exit 1; }
fi

# --- 1. mise Core (Multi-Method Detection) ---
if command -v mise >/dev/null 2>&1; then
    step "Checking mise core"
    if [[ "$(uname -s)" == "Linux" ]] && command -v dpkg >/dev/null 2>&1 && dpkg -s mise >/dev/null 2>&1; then
        # Handle your ZorinOS APT installation
        sudo apt update -y -o Dir::Etc::sourcelist="sources.list.d/jdx.list" >/dev/null 2>&1 || true
        sudo apt install --only-upgrade -y mise >/dev/null 2>&1
        ok
    elif command -v brew >/dev/null 2>&1 && brew list mise >/dev/null 2>&1; then
        # Handle macOS/Linux Brew installation
        brew upgrade mise >/dev/null 2>&1
        ok
    else
        # Fallback for standalone binary installation
        mise self-update -y >/dev/null 2>&1 && ok || skip "manual update needed"
    fi
else
    skip "mise not found"
fi

# --- 2. System & Language Packages ---

# Homebrew
if command -v brew >/dev/null 2>&1; then
    step "Homebrew packages"
    brew update >/dev/null && brew upgrade --quiet >/dev/null
    ok
fi

# NPM Globals (via mise)
if command -v mise >/dev/null 2>&1; then
    step "NPM (claude, gemini, etc)"
    mise exec node -- npm update -g --audit=false >/dev/null 2>&1
    ok
fi

# Pipx (aider, sgpt)
if command -v pipx >/dev/null 2>&1; then
    step "Pipx tools"
    pipx upgrade-all >/dev/null 2>&1
    ok
fi

# --- 3. Specialized AI Binaries ---

# Ollama (Verified Manual Override)
if command -v ollama >/dev/null 2>&1; then
    if [[ "$(uname -s)" == "Linux" ]]; then
        step "Ollama (Manual Deployment)"
        arch="$(uname -m)"
        case "$arch" in
            x86_64|amd64) ollama_arch="amd64" ;;
            aarch64|arm64) ollama_arch="arm64" ;;
            *) ollama_arch="" ;;
        esac

        if [[ -n "$ollama_arch" ]]; then
            tmp_tar="$(mktemp)"
            trap 'rm -f "$tmp_tar"' EXIT
            tar_url="https://ollama.com/download/ollama-linux-${ollama_arch}.tar.zst"

            if curl -fsSL --retry 2 "$tar_url" -o "$tmp_tar" && zstd -t "$tmp_tar" >/dev/null 2>&1; then
                # Stop service safely
                if command -v systemctl >/dev/null 2>&1; then
                    sudo systemctl stop ollama 2>/dev/null || true
                fi

                # Extract and Neuter Installer
                zstd -dc "$tmp_tar" | sudo tar -x -C /usr/local >/dev/null
                curl -fsSL https://ollama.com/install.sh | sed 's/status "Downloading/return 0; status "/' | sh >/dev/null 2>&1

                # Restart if systemd exists
                if command -v systemctl >/dev/null 2>&1; then
                    sudo systemctl start ollama 2>/dev/null || true
                fi
                ok
            else
                err "Integrity check failed"
            fi
        else
            skip "unsupported arch"
        fi
    else
        # macOS users typically use the .app or Brew
        step "Ollama (macOS)"
        command -v brew >/dev/null 2>&1 && brew upgrade ollama --cask >/dev/null 2>&1 && ok || skip "Update via App"
    fi
fi

# LM Studio Runtime
if command -v lms >/dev/null 2>&1; then
    step "LM Studio Runtime"
    lms runtime update >/dev/null 2>&1
    ok
fi

# --- 4. Final Summary ---
echo -e "${GRAY}-----------------------------------------------------------${NC}"
echo -e "${GREEN}${BOLD}Euxis Environment Ready${NC}"

# Clean Table-style Version Report
printf "\n${BOLD}%-12s %s${NC}\n" "System" "Version"
printf "${GRAY}%-12s${NC} %s\n" "Node:" "$(node -v 2>/dev/null || echo 'N/A')"
printf "${GRAY}%-12s${NC} %s\n" "Ollama:" "$(ollama --version 2>/dev/null | awk '{print $NF}' || echo 'N/A')"
printf "${GRAY}%-12s${NC} %s\n" "Pipx:" "$(pipx --version 2>/dev/null || echo 'N/A')"
printf "${GRAY}%-12s${NC} %s\n" "Mise:" "$(mise --version 2>/dev/null | awk '{print $1}' || echo 'N/A')"

trap - EXIT
