#!/usr/bin/env bash
# Hash calculator (MD5, SHA1, SHA256, SHA512)
# Usage: hash [algorithm] <string|file>

set -euo pipefail

usage() {
  echo "Usage: hash [OPTIONS] [INPUT]"
  echo ""
  echo "Algorithms:"
  echo "  -m, --md5       MD5 hash"
  echo "  -1, --sha1      SHA-1 hash"
  echo "  -2, --sha256    SHA-256 hash (default)"
  echo "  -5, --sha512    SHA-512 hash"
  echo "  -a, --all       Show all hashes"
  echo ""
  echo "Options:"
  echo "  -f, --file      Hash file contents"
  echo "  -c, --check     Verify hash (input: hash to verify)"
  echo "  -h, --help      Show this help"
  echo ""
  echo "Examples:"
  echo "  hash 'hello'              # SHA256 of string"
  echo "  hash -m 'hello'           # MD5 of string"
  echo "  hash -f myfile.txt        # SHA256 of file"
  echo "  hash -a 'hello'           # All hashes"
  echo "  hash -c abc123 'hello'    # Verify hash"
}

ALGO="sha256"
FILE_MODE=false
CHECK_MODE=false
ALL_MODE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -m|--md5) ALGO="md5"; shift ;;
    -1|--sha1) ALGO="sha1"; shift ;;
    -2|--sha256) ALGO="sha256"; shift ;;
    -5|--sha512) ALGO="sha512"; shift ;;
    -a|--all) ALL_MODE=true; shift ;;
    -f|--file) FILE_MODE=true; shift ;;
    -c|--check) CHECK_MODE=true; EXPECTED="$2"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    -*) echo "Unknown option: $1"; usage; exit 1 ;;
    *) break ;;
  esac
done

# Get hash command based on algorithm
get_hash_cmd() {
  local algo="$1"
  case "$algo" in
    md5)
      if command -v md5sum >/dev/null 2>&1; then echo "md5sum"
      elif command -v md5 >/dev/null 2>&1; then echo "md5 -q"
      else echo "openssl md5 -r"; fi
      ;;
    sha1)
      if command -v sha1sum >/dev/null 2>&1; then echo "sha1sum"
      elif command -v shasum >/dev/null 2>&1; then echo "shasum -a 1"
      else echo "openssl sha1 -r"; fi
      ;;
    sha256)
      if command -v sha256sum >/dev/null 2>&1; then echo "sha256sum"
      elif command -v shasum >/dev/null 2>&1; then echo "shasum -a 256"
      else echo "openssl sha256 -r"; fi
      ;;
    sha512)
      if command -v sha512sum >/dev/null 2>&1; then echo "sha512sum"
      elif command -v shasum >/dev/null 2>&1; then echo "shasum -a 512"
      else echo "openssl sha512 -r"; fi
      ;;
  esac
}

compute_hash() {
  local algo="$1"
  local input="$2"
  local cmd=$(get_hash_cmd "$algo")

  if $FILE_MODE; then
    $cmd "$input" | awk '{print $1}'
  else
    echo -n "$input" | $cmd | awk '{print $1}'
  fi
}

# Get input
if [[ $# -gt 0 ]]; then
  INPUT="$1"
else
  read -r INPUT
fi

# Validate file mode
if $FILE_MODE && [[ ! -f "$INPUT" ]]; then
  echo "Error: File not found: $INPUT"
  exit 1
fi

if $ALL_MODE; then
  echo "MD5:    $(compute_hash md5 "$INPUT")"
  echo "SHA1:   $(compute_hash sha1 "$INPUT")"
  echo "SHA256: $(compute_hash sha256 "$INPUT")"
  echo "SHA512: $(compute_hash sha512 "$INPUT")"
elif $CHECK_MODE; then
  COMPUTED=$(compute_hash "$ALGO" "$INPUT")
  EXPECTED_LOWER=$(echo "$EXPECTED" | tr '[:upper:]' '[:lower:]')
  COMPUTED_LOWER=$(echo "$COMPUTED" | tr '[:upper:]' '[:lower:]')

  if [[ "$EXPECTED_LOWER" == "$COMPUTED_LOWER" ]]; then
    echo "✓ Hash matches"
    exit 0
  else
    echo "✗ Hash mismatch"
    echo "  Expected: $EXPECTED"
    echo "  Got:      $COMPUTED"
    exit 1
  fi
else
  compute_hash "$ALGO" "$INPUT"
fi
