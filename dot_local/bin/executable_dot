#!/usr/bin/env bash
set -e

# Dotfiles CLI Entry Point - v0.2.476

VERSION="0.2.475"

COMMAND="$1"
if [ -n "$1" ]; then
    shift
fi

show_help() {
    echo "Usage: dot [command]"
    echo ""
    echo "Core Commands:"
    echo "  apply       Apply dotfiles (chezmoi apply)"
    echo "  sync        Apply dotfiles (alias of apply)"
    echo "  update      Pull latest changes and apply them (chezmoi update)"
    echo "  add         Add a file to chezmoi source"
    echo "  diff        Show chezmoi diff with exclusions"
    echo "  status      Show configuration drift (chezmoi status)"
    echo "  remove      Safely remove a managed file"
    echo "  cd          Print source directory path (use: cd \$(dot cd))"
    echo "  edit        Open chezmoi source in \$EDITOR"
    echo ""
    echo "Diagnostics:"
    echo "  doctor      Check system health and configuration"
    echo "  drift       Drift dashboard (detailed chezmoi status)"
    echo "  history     Shell history analysis"
    echo "  benchmark   Run shell startup benchmark"
    echo ""
    echo "Tools:"
    echo "  tools       Show or install nix packages (dot tools [install])"
    echo "  new         Create a new project from a template"
    echo "  sandbox     Launch a safe sandbox preview (Docker/Podman)"
    echo "  keys        Show keybindings catalog"
    echo "  learn       Start the interactive tour of your new tools"
    echo "  docs        Show repo README"
    echo "  log-rotate  Rotate ~/.local/share/dotfiles.log"
    echo ""
    echo "Appearance:"
    echo "  theme       Switch terminal theme (dark/light)"
    echo "  wallpaper   Apply a wallpaper from your library"
    echo "  fonts       Install Nerd Fonts (JetBrainsMono by default)"
    echo "  tune        Apply OS tuning (opt-in)"
    echo ""
    echo "Secrets:"
    echo "  secrets-init    Initialize age key for secrets"
    echo "  secrets         Edit encrypted secrets (age)"
    echo "  secrets-create  Create an encrypted secrets file"
    echo "  ssh-key         Encrypt an SSH key locally with age"
    echo ""
    echo "Security (opt-in):"
    echo "  backup        Create a compressed backup of your home"
    echo "  encrypt-check Check disk encryption status"
    echo "  firewall      Apply firewall hardening"
    echo "  telemetry     Disable OS telemetry"
    echo "  dns-doh       Enable DNS-over-HTTPS"
    echo "  lock-screen   Enforce lock screen idle settings"
    echo "  usb-safety    Disable automount for removable media"
    echo ""
    echo "Meta:"
    echo "  upgrade     Update flake, plugins, and dotfiles"
    echo "  --version   Show version information"
    echo "  help        Show this help message"
}

resolve_source_dir() {
    if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -d "$CHEZMOI_SOURCE_DIR" ]; then
        echo "$CHEZMOI_SOURCE_DIR"
        return
    fi
    if [ -d "$HOME/.dotfiles" ]; then
        echo "$HOME/.dotfiles"
        return
    fi
    if [ -d "$HOME/.local/share/chezmoi" ]; then
        echo "$HOME/.local/share/chezmoi"
        return
    fi
    echo ""
}

case "$COMMAND" in
    --version|-v|version)
        echo "dot v${VERSION}"
        echo "Dotfiles CLI - Cross-platform shell environment distribution"
        echo ""
        echo "Repository: https://github.com/sebastienrousseau/dotfiles"
        echo "Managed by: chezmoi $(chezmoi --version 2>/dev/null | head -1 || echo 'not installed')"
        exit 0
        ;;
    apply)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/ops/chezmoi-apply.sh" ]; then
            exec bash "$SRC_DIR/scripts/ops/chezmoi-apply.sh" "$@"
        else
            exec chezmoi apply
        fi
        ;;
    sync)
        exec "$0" apply "$@"
        ;;
    add)
        # Add a file to chezmoi source
        if [ -z "$1" ]; then
            echo "Usage: dot add <file>"
            echo ""
            echo "Add a file to the chezmoi source directory."
            echo "The file will be managed by chezmoi from now on."
            exit 1
        fi
        exec chezmoi add "$@"
        ;;
    status)
        # Show configuration drift
        exec chezmoi status "$@"
        ;;
    cd)
        # Print source directory path for use with: cd $(dot cd)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ]; then
            echo "$SRC_DIR"
        else
            echo "Dotfiles source not found." >&2
            exit 1
        fi
        ;;
    learn)
        # Execute the interactive tour
        exec "$(dirname "$0")/tour" "$@"
        ;;
    doctor)
        echo "Running Dotfiles Doctor..."
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/diagnostics/doctor.sh" ]; then
            exec bash "$SRC_DIR/scripts/diagnostics/doctor.sh"
        else
            exec chezmoi doctor
        fi
        ;;
    keys)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/KEYS.md" ]; then
            if [ -n "$1" ]; then
                rg -i --context 1 "$1" "$SRC_DIR/docs/KEYS.md" || true
            else
                exec cat "$SRC_DIR/docs/KEYS.md"
            fi
        else
            echo "Keybindings catalog not found."
            exit 1
        fi
        ;;
    sandbox)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if command -v docker >/dev/null; then
            echo "Launching sandbox via Docker..."
            docker build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec docker run --rm -it dotfiles-sandbox
        elif command -v podman >/dev/null; then
            echo "Launching sandbox via Podman..."
            podman build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec podman run --rm -it dotfiles-sandbox
        else
            echo "Docker or Podman is required for sandbox."
            exit 1
        fi
        ;;
    benchmark)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/tests/benchmark.sh" ]; then
            exec bash "$SRC_DIR/scripts/tests/benchmark.sh"
        else
            echo "Benchmark script not found."
            exit 1
        fi
        ;;
    tune)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        case "$(uname -s)" in
            Darwin)
                exec bash "$SRC_DIR/scripts/tuning/macos.sh"
                ;;
            Linux)
                exec bash "$SRC_DIR/scripts/tuning/linux.sh"
                ;;
            *)
                echo "OS tuning not supported on this platform."
                exit 1
                ;;
        esac
        ;;
    theme)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/theme/switch.sh" ]; then
            exec sh "$SRC_DIR/scripts/theme/switch.sh" "$@"
        else
            echo "Theme switcher not found."
            exit 1
        fi
        ;;
    wallpaper)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/theme/wallpaper-sync.sh" ]; then
            exec sh "$SRC_DIR/scripts/theme/wallpaper-sync.sh" "$@"
        else
            echo "Wallpaper script not found."
            exit 1
        fi
        ;;
    fonts)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh" ]; then
            exec sh "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh" "$@"
        else
            echo "Font install script not found."
            exit 1
        fi
        ;;
    firewall)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/firewall.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/firewall.sh" "$@"
        else
            echo "Firewall script not found."
            exit 1
        fi
        ;;
    telemetry)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/telemetry-kill.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/telemetry-kill.sh" "$@"
        else
            echo "Telemetry script not found."
            exit 1
        fi
        ;;
    dns-doh)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/dns-doh.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/dns-doh.sh" "$@"
        else
            echo "DNS DoH script not found."
            exit 1
        fi
        ;;
    encrypt-check)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/encryption-check.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/encryption-check.sh" "$@"
        else
            echo "Encryption check script not found."
            exit 1
        fi
        ;;
    lock-screen)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/lock-screen.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/lock-screen.sh" "$@"
        else
            echo "Lock screen script not found."
            exit 1
        fi
        ;;
    usb-safety)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/usb-safety.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/usb-safety.sh" "$@"
        else
            echo "USB safety script not found."
            exit 1
        fi
        ;;
    backup)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/backup.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/backup.sh" "$@"
        else
            echo "Backup script not found."
            exit 1
        fi
        ;;
    ssh-key)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/secrets/encrypt-ssh-key.sh" ]; then
            exec sh "$SRC_DIR/scripts/secrets/encrypt-ssh-key.sh" "$@"
        else
            echo "SSH key encryption script not found."
            exit 1
        fi
        ;;
    secrets-init)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/secrets/age-init.sh" ]; then
            exec bash "$SRC_DIR/scripts/secrets/age-init.sh"
        else
            SECRETS_DIR="$HOME/.config/chezmoi"
            KEY_FILE="$SECRETS_DIR/key.txt"
            mkdir -p "$SECRETS_DIR"
            if [ -f "$KEY_FILE" ]; then
                echo "Age key already exists: $KEY_FILE"
                exit 0
            fi
            if ! command -v age-keygen >/dev/null; then
                echo "age-keygen not found. Install 'age' first."
                exit 1
            fi
            age-keygen -o "$KEY_FILE"
            chmod 600 "$KEY_FILE"
            echo "Age key created at $KEY_FILE"
            echo "Public key:"
            age-keygen -y "$KEY_FILE"
        fi
        ;;
    secrets-create)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/secrets/create-secrets-file.sh" ]; then
            exec sh "$SRC_DIR/scripts/secrets/create-secrets-file.sh" "$@"
        else
            echo "Secrets creation script not found."
            exit 1
        fi
        ;;
    secrets)
        SECRETS_DIR="$HOME/.config/chezmoi"
        KEY_FILE="$SECRETS_DIR/key.txt"
        if [ ! -f "$KEY_FILE" ]; then
            echo "No age key found. Run: dot secrets-init"
            exit 1
        fi
        exec chezmoi edit --apply "$HOME/.config/chezmoi/encrypted_secrets.age"
        ;;
    upgrade)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/nix/flake.nix" ] && command -v nix >/dev/null; then
            echo "Updating Nix flake..."
            (cd "$SRC_DIR" && nix flake update) || true
            echo "Running Nix garbage collection..."
            nix-collect-garbage -d || true
        fi
        echo "Updating dotfiles..."
        chezmoi update || true
        if command -v nvim >/dev/null; then
            echo "Updating Neovim plugins..."
            nvim --headless "+Lazy! sync" +qa || true
        fi
        if [ "${DOTFILES_FONTS:-}" = "1" ]; then
            if [ -f "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh" ]; then
                echo "Installing Nerd Fonts..."
                sh "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh"
            fi
        fi
        ;;
    edit)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        exec chezmoi edit "$SRC_DIR"
        ;;
    docs)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/README.md" ]; then
            exec cat "$SRC_DIR/README.md"
        else
            echo "README not found."
            exit 1
        fi
        ;;
    update)
        # Update dotfiles
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/ops/chezmoi-update.sh" ]; then
            exec bash "$SRC_DIR/scripts/ops/chezmoi-update.sh" "$@"
        else
            echo "Updating Dotfiles..."
            exec chezmoi update
        fi
        ;;
    diff)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/ops/chezmoi-diff.sh" ]; then
            exec bash "$SRC_DIR/scripts/ops/chezmoi-diff.sh" "$@"
        else
            exec chezmoi diff "$@"
        fi
        ;;
    remove)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/ops/chezmoi-remove.sh" ]; then
            exec bash "$SRC_DIR/scripts/ops/chezmoi-remove.sh" "$@"
        else
            echo "Remove helper not found."
            exit 1
        fi
        ;;
    drift)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/diagnostics/drift-dashboard.sh" ]; then
            exec bash "$SRC_DIR/scripts/diagnostics/drift-dashboard.sh"
        else
            exec chezmoi status
        fi
        ;;
    history)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/diagnostics/history-analysis.sh" ]; then
            exec bash "$SRC_DIR/scripts/diagnostics/history-analysis.sh"
        else
            echo "History analysis script not found."
            exit 1
        fi
        ;;
    tools)
        SRC_DIR="$(resolve_source_dir)"
        SUBCOMMAND="${1:-}"
        if [ "$SUBCOMMAND" = "install" ]; then
            # Install tools via nix
            if ! command -v nix >/dev/null 2>&1; then
                echo "Nix is not installed."
                echo ""
                echo "To install Nix, run:"
                echo "  curl -L https://nixos.org/nix/install | sh"
                echo ""
                echo "Or use Homebrew/apt for individual tools."
                exit 1
            fi
            shift
            if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/nix/flake.nix" ]; then
                echo "Entering Nix development shell..."
                exec nix develop "$SRC_DIR/nix" "$@"
            else
                echo "Nix flake not found in source directory."
                exit 1
            fi
        elif [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/TOOLS.md" ]; then
            exec cat "$SRC_DIR/docs/TOOLS.md"
        elif [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/UTILS.md" ]; then
            exec cat "$SRC_DIR/docs/UTILS.md"
        else
            echo "Dot Tools:"
            echo ""
            echo "Usage: dot tools [command]"
            echo ""
            echo "Commands:"
            echo "  (none)    Show tools documentation"
            echo "  install   Enter Nix development shell with all tools"
            echo ""
            echo "Quick Reference:"
            echo "  dot sync       - Apply dotfiles"
            echo "  dot update     - Pull latest changes and apply"
            echo "  dot doctor     - Run health checks"
            echo "  dot keys       - Show keybindings catalog"
            echo "  dot learn      - Interactive tour"
        fi
        ;;
    new)
        LANG="$1"
        NAME="$2"
        if [ -z "$LANG" ] || [ -z "$NAME" ]; then
            echo "Usage: dot new <lang> <name>"
            echo "Available templates: python, go, node"
            exit 1
        fi
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        TEMPLATE_DIR="$SRC_DIR/templates/projects/$LANG"
        if [ ! -d "$TEMPLATE_DIR" ]; then
            echo "Unknown template: $LANG"
            echo "Available templates: python, go, node"
            exit 1
        fi
        DEST="$PWD/$NAME"
        if [ -e "$DEST" ]; then
            echo "Destination exists: $DEST"
            exit 1
        fi
        mkdir -p "$DEST"
        cp -R "$TEMPLATE_DIR/." "$DEST"
        find "$DEST" -depth -name "__PROJECT_NAME__" -print0 | while IFS= read -r -d '' path; do
            parent="$(dirname "$path")"
            mv "$path" "$parent/$NAME"
        done
        if command -v python3 >/dev/null 2>&1; then
            find "$DEST" -type f -print0 | while IFS= read -r -d '' file; do
                python3 - "$file" "$NAME" <<'PY'
import sys

path = sys.argv[1]
name = sys.argv[2]
with open(path, "r", encoding="utf-8") as f:
    data = f.read()
data = data.replace("__PROJECT_NAME__", name)
with open(path, "w", encoding="utf-8") as f:
    f.write(data)
PY
            done
        elif command -v python >/dev/null 2>&1; then
            find "$DEST" -type f -print0 | while IFS= read -r -d '' file; do
                python - "$file" "$NAME" <<'PY'
import sys

path = sys.argv[1]
name = sys.argv[2]
with open(path, "r", encoding="utf-8") as f:
    data = f.read()
data = data.replace("__PROJECT_NAME__", name)
with open(path, "w", encoding="utf-8") as f:
    f.write(data)
PY
            done
        else
            echo "python3 is required to render templates."
            exit 1
        fi
        echo "Created $LANG project at $DEST"
        ;;
    log-rotate)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/tools/log-rotate.sh" ]; then
            exec bash "$SRC_DIR/scripts/tools/log-rotate.sh"
        else
            echo "Log rotation script not found."
            exit 1
        fi
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -z "$COMMAND" ]; then
            show_help
        else
            echo "Unknown command: $COMMAND"
            echo "Try 'dot help' for usage."
            exit 1
        fi
        ;;
esac
