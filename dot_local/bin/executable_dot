#!/usr/bin/env bash
# Dotfiles CLI Entry Point - v0.2.481
# Modular architecture with command handlers in scripts/dot/commands/

set -e

VERSION="0.2.481"

COMMAND="$1"
if [ -n "$1" ]; then
  shift
fi

# Resolve the dotfiles source directory
resolve_source_dir() {
  if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -d "$CHEZMOI_SOURCE_DIR" ]; then
    echo "$CHEZMOI_SOURCE_DIR"
    return
  fi
  if [ -d "$HOME/.dotfiles" ]; then
    echo "$HOME/.dotfiles"
    return
  fi
  if [ -d "$HOME/.local/share/chezmoi" ]; then
    echo "$HOME/.local/share/chezmoi"
    return
  fi
  echo ""
}

show_help() {
  if command -v gum >/dev/null 2>&1 && [[ -t 1 ]]; then
    gum style --foreground 212 --bold "Dotfiles CLI"
    printf "\n"
    gum style --bold "Usage"
    printf "  %s\n\n" "$(gum style --foreground 2 "dot") [command]"

    gum style --bold "Core Commands"
    printf "  %-10s %s\n" "$(gum style --foreground 2 apply)" "Apply dotfiles (chezmoi apply)"
    printf "  %-10s %s\n" "$(gum style --foreground 2 sync)" "Apply dotfiles (alias of apply)"
    printf "  %-10s %s\n" "$(gum style --foreground 2 update)" "Pull latest changes and apply them (chezmoi update)"
    printf "  %-10s %s\n" "$(gum style --foreground 2 add)" "Add a file to chezmoi source"
    printf "  %-10s %s\n" "$(gum style --foreground 2 diff)" "Show chezmoi diff with exclusions"
    printf "  %-10s %s\n" "$(gum style --foreground 2 status)" "Show configuration drift (chezmoi status)"
    printf "  %-10s %s\n" "$(gum style --foreground 2 remove)" "Safely remove a managed file"
    printf "  %-10s %s\n" "$(gum style --foreground 2 cd)" "Print source directory path (use: cd $(dot cd))"
    printf "  %-10s %s\n" "$(gum style --foreground 2 edit)" "Open chezmoi source in \$EDITOR"
    printf "\n"

    gum style --bold "Diagnostics"
    printf "  %-15s %s\n" "$(gum style --foreground 2 doctor)" "Check system health and configuration"
    printf "  %-15s %s\n" "$(gum style --foreground 2 heal)" "Auto-repair common dotfiles issues"
    printf "  %-15s %s\n" "$(gum style --foreground 2 health)" "Run comprehensive health dashboard"
    printf "  %-15s %s\n" "$(gum style --foreground 2 security-score)" "Security assessment with grading"
    printf "  %-15s %s\n" "$(gum style --foreground 2 rollback)" "Rollback dotfiles to a previous state"
    printf "  %-15s %s\n" "$(gum style --foreground 2 restore)" "Restore from backup or git ref"
    printf "  %-15s %s\n" "$(gum style --foreground 2 drift)" "Drift dashboard (detailed chezmoi status)"
    printf "  %-15s %s\n" "$(gum style --foreground 2 history)" "Shell history analysis"
    printf "  %-15s %s\n" "$(gum style --foreground 2 benchmark)" "Run shell startup benchmark (--detailed, --profile)"
    printf "\n"

    gum style --bold "Tools"
    printf "  %-10s %s\n" "$(gum style --foreground 2 tools)" "Show or install nix packages (dot tools [install])"
    printf "  %-10s %s\n" "$(gum style --foreground 2 new)" "Create a new project from a template"
    printf "  %-10s %s\n" "$(gum style --foreground 2 sandbox)" "Launch a safe sandbox preview (Docker/Podman)"
    printf "  %-10s %s\n" "$(gum style --foreground 2 keys)" "Show keybindings catalog"
    printf "  %-10s %s\n" "$(gum style --foreground 2 learn)" "Start the interactive tour of your new tools"
    printf "  %-10s %s\n" "$(gum style --foreground 2 docs)" "Show repo README"
    printf "  %-10s %s\n" "$(gum style --foreground 2 log-rotate)" "Rotate ~/.local/share/dotfiles.log"
    printf "\n"

    gum style --bold "Appearance"
    printf "  %-10s %s\n" "$(gum style --foreground 2 theme)" "Switch terminal theme (dark/light)"
    printf "  %-10s %s\n" "$(gum style --foreground 2 wallpaper)" "Apply a wallpaper from your library"
    printf "  %-10s %s\n" "$(gum style --foreground 2 fonts)" "Install Nerd Fonts (JetBrainsMono by default)"
    printf "  %-10s %s\n" "$(gum style --foreground 2 tune)" "Apply OS tuning (opt-in)"
    printf "\n"

    gum style --bold "Secrets"
    printf "  %-15s %s\n" "$(gum style --foreground 2 secrets-init)" "Initialize age key for secrets"
    printf "  %-15s %s\n" "$(gum style --foreground 2 secrets)" "Edit encrypted secrets (age)"
    printf "  %-15s %s\n" "$(gum style --foreground 2 secrets-create)" "Create an encrypted secrets file"
    printf "  %-15s %s\n" "$(gum style --foreground 2 ssh-key)" "Encrypt an SSH key locally with age"
    printf "\n"

    gum style --bold "Security (opt-in)"
    printf "  %-12s %s\n" "$(gum style --foreground 2 backup)" "Create a compressed backup of your home"
    printf "  %-12s %s\n" "$(gum style --foreground 2 encrypt-check)" "Check disk encryption status"
    printf "  %-12s %s\n" "$(gum style --foreground 2 firewall)" "Apply firewall hardening"
    printf "  %-12s %s\n" "$(gum style --foreground 2 telemetry)" "Disable OS telemetry"
    printf "  %-12s %s\n" "$(gum style --foreground 2 dns-doh)" "Enable DNS-over-HTTPS"
    printf "  %-12s %s\n" "$(gum style --foreground 2 lock-screen)" "Enforce lock screen idle settings"
    printf "  %-12s %s\n" "$(gum style --foreground 2 usb-safety)" "Disable automount for removable media"
    printf "\n"

    gum style --bold "Meta"
    printf "  %-10s %s\n" "$(gum style --foreground 2 upgrade)" "Update flake, plugins, and dotfiles"
    printf "  %-10s %s\n" "$(gum style --foreground 2 packages)" "List installed packages and package managers"
    printf "  %-10s %s\n" "$(gum style --foreground 2 -- --version)" "Show version information"
    printf "  %-10s %s\n" "$(gum style --foreground 2 help)" "Show this help message"
    return
  fi

  cat <<'EOF'
Usage: dot [command]

Core Commands:
  apply       Apply dotfiles (chezmoi apply)
  sync        Apply dotfiles (alias of apply)
  update      Pull latest changes and apply them (chezmoi update)
  add         Add a file to chezmoi source
  diff        Show chezmoi diff with exclusions
  status      Show configuration drift (chezmoi status)
  remove      Safely remove a managed file
  cd          Print source directory path (use: cd $(dot cd))
  edit        Open chezmoi source in $EDITOR

Diagnostics:
  doctor         Check system health and configuration
  heal           Auto-repair common dotfiles issues
  health         Run comprehensive health dashboard
  security-score Security assessment with grading
  rollback       Rollback dotfiles to a previous state
  restore        Restore from backup or git ref
  drift          Drift dashboard (detailed chezmoi status)
  history        Shell history analysis
  benchmark      Run shell startup benchmark (--detailed, --profile)

Tools:
  tools       Show or install nix packages (dot tools [install])
  new         Create a new project from a template
  sandbox     Launch a safe sandbox preview (Docker/Podman)
  keys        Show keybindings catalog
  learn       Start the interactive tour of your new tools
  docs        Show repo README
  log-rotate  Rotate ~/.local/share/dotfiles.log

Appearance:
  theme       Switch terminal theme (dark/light)
  wallpaper   Apply a wallpaper from your library
  fonts       Install Nerd Fonts (JetBrainsMono by default)
  tune        Apply OS tuning (opt-in)

Secrets:
  secrets-init    Initialize age key for secrets
  secrets         Edit encrypted secrets (age)
  secrets-create  Create an encrypted secrets file
  ssh-key         Encrypt an SSH key locally with age

Security (opt-in):
  backup        Create a compressed backup of your home
  encrypt-check Check disk encryption status
  firewall      Apply firewall hardening
  telemetry     Disable OS telemetry
  dns-doh       Enable DNS-over-HTTPS
  lock-screen   Enforce lock screen idle settings
  usb-safety    Disable automount for removable media

Meta:
  upgrade     Update flake, plugins, and dotfiles
  packages    List installed packages and package managers
  --version   Show version information
  help        Show this help message
EOF
}

# Dispatch to command module
dispatch() {
  local module="$1"
  local cmd="$2"
  shift 2

  local src_dir
  src_dir="$(resolve_source_dir)"
  if [ -z "$src_dir" ]; then
    echo "Dotfiles source not found." >&2
    exit 1
  fi

  local module_path="$src_dir/scripts/dot/commands/$module.sh"
  if [ -f "$module_path" ]; then
    exec bash "$module_path" "$cmd" "$@"
  else
    echo "Command module not found: $module" >&2
    exit 1
  fi
}

case "$COMMAND" in
  # Version
  --version|-v|version)
    echo "dot v${VERSION}"
    echo "Dotfiles CLI - Cross-platform shell environment distribution"
    echo ""
    echo "Repository: https://github.com/sebastienrousseau/dotfiles"
    echo "Managed by: chezmoi $(chezmoi --version 2>/dev/null | head -1 || echo 'not installed')"
    exit 0
    ;;

  # Core commands
  apply|sync|update|add|diff|status|remove|cd|edit)
    dispatch "core" "$COMMAND" "$@"
    ;;

  # Diagnostics
  doctor|heal|health|health-check|security-score|rollback|restore|drift|history|benchmark)
    dispatch "diagnostics" "$COMMAND" "$@"
    ;;

  # Tools
  tools|new|packages|log-rotate)
    dispatch "tools" "$COMMAND" "$@"
    ;;

  # Appearance
  theme|wallpaper|fonts|tune)
    dispatch "appearance" "$COMMAND" "$@"
    ;;

  # Secrets
  secrets-init|secrets|secrets-create|ssh-key)
    dispatch "secrets" "$COMMAND" "$@"
    ;;

  # Security
  backup|encrypt-check|firewall|telemetry|dns-doh|lock-screen|usb-safety)
    dispatch "security" "$COMMAND" "$@"
    ;;

  # Meta
  upgrade|docs|learn|keys|sandbox)
    dispatch "meta" "$COMMAND" "$@"
    ;;

  # Help
  help|--help|-h)
    show_help
    ;;

  # Unknown or empty
  *)
    if [ -z "$COMMAND" ]; then
      show_help
    else
      echo "Unknown command: $COMMAND"
      echo "Try 'dot help' for usage."
      exit 1
    fi
    ;;
esac
