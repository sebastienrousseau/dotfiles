#!/bin/sh
set -e

# Dotfiles CLI Entry Point - v0.2.473

COMMAND="$1"
if [ -n "$1" ]; then
    shift
fi

show_help() {
    echo "Usage: dot [command]"
    echo ""
    echo "Commands:"
    echo "  sync       Apply dotfiles (chezmoi apply)"
    echo "  update     Pull latest changes and apply them (chezmoi update)"
    echo "  doctor     Check system health and configuration"
    echo "  keys       Show keybindings catalog"
    echo "  sandbox    Launch a safe sandbox preview (Docker/Podman)"
    echo "  benchmark  Run shell startup benchmark"
    echo "  tune       Apply OS tuning (opt-in)"
    echo "  theme      Switch terminal theme (dark/light)"
    echo "  wallpaper  Apply a wallpaper from your library"
    echo "  ssh-key    Encrypt an SSH key locally with age"
    echo "  secrets-create  Create an encrypted secrets file"
    echo "  fonts      Install Nerd Fonts (JetBrainsMono by default)"
    echo "  firewall   Apply firewall hardening (opt-in)"
    echo "  telemetry  Disable OS telemetry (opt-in)"
    echo "  dns-doh    Enable DNS-over-HTTPS (opt-in)"
    echo "  encrypt-check  Check disk encryption status"
    echo "  backup     Create a compressed backup of your home"
    echo "  lock-screen  Enforce lock screen idle settings (opt-in)"
    echo "  usb-safety   Disable automount for removable media (opt-in)"
    echo "  secrets    Edit encrypted secrets (age)"
    echo "  secrets-init  Initialize age key for secrets"
    echo "  upgrade    Update flake, plugins, and dotfiles"
    echo "  edit       Open chezmoi source in $EDITOR"
    echo "  docs       Show repo README"
    echo "  learn      Start the interactive tour of your new tools"
    echo "  tools      Show dot utils overview"
    echo "  new        Create a new project from a template"
    echo "  help       Show this help message"
}

resolve_source_dir() {
    if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -d "$CHEZMOI_SOURCE_DIR" ]; then
        echo "$CHEZMOI_SOURCE_DIR"
        return
    fi
    if [ -d "$HOME/.dotfiles" ]; then
        echo "$HOME/.dotfiles"
        return
    fi
    if [ -d "$HOME/.local/share/chezmoi" ]; then
        echo "$HOME/.local/share/chezmoi"
        return
    fi
    echo ""
}

case "$COMMAND" in
    sync)
        echo "Applying Dotfiles..."
        exec chezmoi apply
        ;;
    learn)
        # Execute the interactive tour
        exec "$(dirname "$0")/tour" "$@"
        ;;
    doctor)
        echo "Running Dotfiles Doctor..."
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/diagnostics/doctor.sh" ]; then
            exec bash "$SRC_DIR/scripts/diagnostics/doctor.sh"
        else
            exec chezmoi doctor
        fi
        ;;
    keys)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/KEYS.md" ]; then
            if [ -n "$1" ]; then
                rg -i --context 1 "$1" "$SRC_DIR/docs/KEYS.md" || true
            else
                exec cat "$SRC_DIR/docs/KEYS.md"
            fi
        else
            echo "Keybindings catalog not found."
            exit 1
        fi
        ;;
    sandbox)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if command -v docker >/dev/null; then
            echo "Launching sandbox via Docker..."
            docker build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec docker run --rm -it dotfiles-sandbox
        elif command -v podman >/dev/null; then
            echo "Launching sandbox via Podman..."
            podman build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec podman run --rm -it dotfiles-sandbox
        else
            echo "Docker or Podman is required for sandbox."
            exit 1
        fi
        ;;
    benchmark)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/tests/benchmark.sh" ]; then
            exec bash "$SRC_DIR/scripts/tests/benchmark.sh"
        else
            echo "Benchmark script not found."
            exit 1
        fi
        ;;
    tune)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        case "$(uname -s)" in
            Darwin)
                exec bash "$SRC_DIR/scripts/tuning/macos.sh"
                ;;
            Linux)
                exec bash "$SRC_DIR/scripts/tuning/linux.sh"
                ;;
            *)
                echo "OS tuning not supported on this platform."
                exit 1
                ;;
        esac
        ;;
    theme)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/theme/switch.sh" ]; then
            exec sh "$SRC_DIR/scripts/theme/switch.sh" "$@"
        else
            echo "Theme switcher not found."
            exit 1
        fi
        ;;
    wallpaper)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/theme/wallpaper-sync.sh" ]; then
            exec sh "$SRC_DIR/scripts/theme/wallpaper-sync.sh" "$@"
        else
            echo "Wallpaper script not found."
            exit 1
        fi
        ;;
    fonts)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh" ]; then
            exec sh "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh" "$@"
        else
            echo "Font install script not found."
            exit 1
        fi
        ;;
    firewall)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/firewall.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/firewall.sh" "$@"
        else
            echo "Firewall script not found."
            exit 1
        fi
        ;;
    telemetry)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/telemetry-kill.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/telemetry-kill.sh" "$@"
        else
            echo "Telemetry script not found."
            exit 1
        fi
        ;;
    dns-doh)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/dns-doh.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/dns-doh.sh" "$@"
        else
            echo "DNS DoH script not found."
            exit 1
        fi
        ;;
    encrypt-check)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/encryption-check.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/encryption-check.sh" "$@"
        else
            echo "Encryption check script not found."
            exit 1
        fi
        ;;
    lock-screen)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/lock-screen.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/lock-screen.sh" "$@"
        else
            echo "Lock screen script not found."
            exit 1
        fi
        ;;
    usb-safety)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/usb-safety.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/usb-safety.sh" "$@"
        else
            echo "USB safety script not found."
            exit 1
        fi
        ;;
    backup)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/security/backup.sh" ]; then
            exec sh "$SRC_DIR/scripts/security/backup.sh" "$@"
        else
            echo "Backup script not found."
            exit 1
        fi
        ;;
    ssh-key)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/secrets/encrypt-ssh-key.sh" ]; then
            exec sh "$SRC_DIR/scripts/secrets/encrypt-ssh-key.sh" "$@"
        else
            echo "SSH key encryption script not found."
            exit 1
        fi
        ;;
    secrets-init)
        SECRETS_DIR="$HOME/.config/chezmoi"
        KEY_FILE="$SECRETS_DIR/key.txt"
        mkdir -p "$SECRETS_DIR"
        if [ -f "$KEY_FILE" ]; then
            echo "Age key already exists: $KEY_FILE"
            exit 0
        fi
        if ! command -v age-keygen >/dev/null; then
            echo "age-keygen not found. Install 'age' first."
            exit 1
        fi
        age-keygen -o "$KEY_FILE"
        chmod 600 "$KEY_FILE"
        echo "Age key created at $KEY_FILE"
        echo "Public key:"
        age-keygen -y "$KEY_FILE"
        ;;
    secrets-create)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/scripts/secrets/create-secrets-file.sh" ]; then
            exec sh "$SRC_DIR/scripts/secrets/create-secrets-file.sh" "$@"
        else
            echo "Secrets creation script not found."
            exit 1
        fi
        ;;
    secrets)
        SECRETS_DIR="$HOME/.config/chezmoi"
        KEY_FILE="$SECRETS_DIR/key.txt"
        if [ ! -f "$KEY_FILE" ]; then
            echo "No age key found. Run: dot secrets-init"
            exit 1
        fi
        exec chezmoi edit --apply "$HOME/.config/chezmoi/encrypted_secrets.age"
        ;;
    upgrade)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/nix/flake.nix" ] && command -v nix >/dev/null; then
            echo "Updating Nix flake..."
            (cd "$SRC_DIR" && nix flake update) || true
            echo "Running Nix garbage collection..."
            nix-collect-garbage -d || true
        fi
        echo "Updating dotfiles..."
        chezmoi update || true
        if command -v nvim >/dev/null; then
            echo "Updating Neovim plugins..."
            nvim --headless "+Lazy! sync" +qa || true
        fi
        if [ "${DOTFILES_FONTS:-}" = "1" ]; then
            if [ -f "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh" ]; then
                echo "Installing Nerd Fonts..."
                sh "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh"
            fi
        fi
        ;;
    edit)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        exec chezmoi edit "$SRC_DIR"
        ;;
    docs)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/README.md" ]; then
            exec cat "$SRC_DIR/README.md"
        else
            echo "README not found."
            exit 1
        fi
        ;;
    update)
        # Update dotfiles
        echo "Updating Dotfiles..."
        exec chezmoi update
        ;;
    tools)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/UTILS.md" ]; then
            exec cat "$SRC_DIR/docs/UTILS.md"
        else
            echo "Dot Utils:"
            echo "  dot sync       - Apply dotfiles"
            echo "  dot update     - Pull latest changes and apply"
            echo "  dot doctor     - Run health checks"
            echo "  dot keys       - Show keybindings catalog"
            echo "  dot learn      - Interactive tour"
        fi
        ;;
    new)
        LANG="$1"
        NAME="$2"
        if [ -z "$LANG" ] || [ -z "$NAME" ]; then
            echo "Usage: dot new <lang> <name>"
            echo "Available templates: python, go, node"
            exit 1
        fi
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        TEMPLATE_DIR="$SRC_DIR/templates/projects/$LANG"
        if [ ! -d "$TEMPLATE_DIR" ]; then
            echo "Unknown template: $LANG"
            echo "Available templates: python, go, node"
            exit 1
        fi
        DEST="$PWD/$NAME"
        if [ -e "$DEST" ]; then
            echo "Destination exists: $DEST"
            exit 1
        fi
        mkdir -p "$DEST"
        cp -R "$TEMPLATE_DIR/." "$DEST"
        find "$DEST" -depth -name "__PROJECT_NAME__" -print0 | while IFS= read -r -d '' path; do
            parent="$(dirname "$path")"
            mv "$path" "$parent/$NAME"
        done
        if command -v python3 >/dev/null 2>&1; then
            find "$DEST" -type f -print0 | while IFS= read -r -d '' file; do
                python3 - "$file" "$NAME" <<'PY'
import sys

path = sys.argv[1]
name = sys.argv[2]
with open(path, "r", encoding="utf-8") as f:
    data = f.read()
data = data.replace("__PROJECT_NAME__", name)
with open(path, "w", encoding="utf-8") as f:
    f.write(data)
PY
            done
        elif command -v python >/dev/null 2>&1; then
            find "$DEST" -type f -print0 | while IFS= read -r -d '' file; do
                python - "$file" "$NAME" <<'PY'
import sys

path = sys.argv[1]
name = sys.argv[2]
with open(path, "r", encoding="utf-8") as f:
    data = f.read()
data = data.replace("__PROJECT_NAME__", name)
with open(path, "w", encoding="utf-8") as f:
    f.write(data)
PY
            done
        else
            echo "python3 is required to render templates."
            exit 1
        fi
        echo "Created $LANG project at $DEST"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -z "$COMMAND" ]; then
            show_help
        else
            echo "Unknown command: $COMMAND"
            echo "Try 'dot help' for usage."
            exit 1
        fi
        ;;
esac
