#!/usr/bin/env bash
# Dotfiles CLI Entry Point - v0.2.485
# Modular architecture with command handlers in scripts/dot/commands/

set -e

VERSION="0.2.485"

COMMAND="$1"
if [ -n "$1" ]; then
  shift
fi

# Resolve the dotfiles source directory
resolve_source_dir() {
  if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -d "$CHEZMOI_SOURCE_DIR" ]; then
    echo "$CHEZMOI_SOURCE_DIR"
    return
  fi
  if [ -d "$HOME/.dotfiles" ]; then
    echo "$HOME/.dotfiles"
    return
  fi
  if [ -d "$HOME/.local/share/chezmoi" ]; then
    echo "$HOME/.local/share/chezmoi"
    return
  fi
  echo ""
}

load_ui() {
  local src_dir
  src_dir="$(resolve_source_dir)"
  if [ -n "$src_dir" ] && [ -f "$src_dir/scripts/dot/lib/ui.sh" ]; then
    # shellcheck source=/dev/null
    source "$src_dir/scripts/dot/lib/ui.sh"
    return 0
  fi
  return 1
}

show_help() {
  if load_ui; then
    ui_init
    cmd_line() {
      local cmd="$1"
      local desc="$2"
      local width=14
      if [[ "${UI_COLOR:-0}" = "1" ]]; then
        printf "  %b%-*s%b %s\n" "${GREEN}" "$width" "$cmd" "${NORMAL}" "$desc"
      else
        printf "  %-*s %s\n" "$width" "$cmd" "$desc"
      fi
    }

    ui_logo_dot "Dot • Command Reference"
    ui_key_value "Version" "v${VERSION}"
    ui_key_value "Summary" "Manage and maintain your dotfiles environment."
    printf "\n"
    ui_section "Core"
    cmd_line "apply" "Apply dotfiles (chezmoi apply)"
    cmd_line "sync" "Apply dotfiles (alias of apply)"
    cmd_line "update" "Pull latest changes and apply them (chezmoi update)"
    cmd_line "add" "Add a file to chezmoi source"
    cmd_line "diff" "Show chezmoi diff with exclusions"
    cmd_line "status" "Show configuration drift (chezmoi status)"
    cmd_line "remove" "Safely remove a managed file"
    cmd_line "cd" "Print source directory path (use: cd \$(dot cd))"
    cmd_line "edit" "Open chezmoi source in \$EDITOR"

    ui_section "Diagnostics"
    cmd_line "doctor" "Check system health and configuration"
    cmd_line "heal" "Auto-repair common dotfiles issues"
    cmd_line "health" "Run comprehensive health dashboard"
    cmd_line "security-score" "Security assessment with grading"
    cmd_line "rollback" "Rollback dotfiles to a previous state"
    cmd_line "restore" "Restore from backup or git ref"
    cmd_line "drift" "Drift dashboard (detailed chezmoi status)"
    cmd_line "history" "Shell history analysis"
    cmd_line "benchmark" "Run shell startup benchmark (--detailed, --profile)"

    ui_section "Tools"
    cmd_line "tools" "Show or install nix packages (dot tools [install])"
    cmd_line "new" "Create a new project from a template"
    cmd_line "sandbox" "Launch a safe sandbox preview (Docker/Podman)"
    cmd_line "keys" "Show keybindings catalog"
    cmd_line "mcp" "Inspect MCP server security and configuration"
    cmd_line "learn" "Start the interactive tour of your new tools"
    cmd_line "docs" "Show repo README"
    cmd_line "log-rotate" "Rotate ~/.local/share/dotfiles.log"

    ui_section "Appearance"
    cmd_line "theme" "Switch terminal theme (dark/light)"
    cmd_line "wallpaper" "Apply a wallpaper from your library"
    cmd_line "fonts" "Install Nerd Fonts (JetBrainsMono by default)"
    cmd_line "tune" "Apply OS tuning (opt-in)"

    ui_section "Secrets"
    cmd_line "secrets-init" "Initialize age key for secrets"
    cmd_line "secrets" "Edit encrypted secrets (age)"
    cmd_line "secrets-create" "Create an encrypted secrets file"
    cmd_line "ssh-key" "Encrypt an SSH key locally with age"

    ui_section "Security (opt-in)"
    cmd_line "backup" "Create a compressed backup of your home"
    cmd_line "encrypt-check" "Check disk encryption status"
    cmd_line "firewall" "Apply firewall hardening"
    cmd_line "telemetry" "Disable OS telemetry"
    cmd_line "dns-doh" "Enable DNS-over-HTTPS"
    cmd_line "lock-screen" "Enforce lock screen idle settings"
    cmd_line "usb-safety" "Disable automount for removable media"

    ui_section "Meta"
    cmd_line "upgrade" "Update flake, plugins, and dotfiles"
    cmd_line "packages" "List installed packages and package managers"
    cmd_line "--version" "Show version information"
    cmd_line "help" "Show this help message"
  else
    cat <<EOF
Usage: dot [command]

Version: v${VERSION}
Summary: Manage and maintain your dotfiles environment.

Core Commands:
  apply       Apply dotfiles (chezmoi apply)
  sync        Apply dotfiles (alias of apply)
  update      Pull latest changes and apply them (chezmoi update)
  add         Add a file to chezmoi source
  diff        Show chezmoi diff with exclusions
  status      Show configuration drift (chezmoi status)
  remove      Safely remove a managed file
  cd          Print source directory path (use: cd $(dot cd))
  edit        Open chezmoi source in $EDITOR

Diagnostics:
  doctor         Check system health and configuration
  heal           Auto-repair common dotfiles issues
  health         Run comprehensive health dashboard
  security-score Security assessment with grading
  rollback       Rollback dotfiles to a previous state
  restore        Restore from backup or git ref
  drift          Drift dashboard (detailed chezmoi status)
  history        Shell history analysis
  benchmark      Run shell startup benchmark (--detailed, --profile)

Tools:
  tools       Show or install nix packages (dot tools [install])
  new         Create a new project from a template
  sandbox     Launch a safe sandbox preview (Docker/Podman)
  keys        Show keybindings catalog
  mcp         Inspect MCP server security and configuration
  learn       Start the interactive tour of your new tools
  docs        Show repo README
  log-rotate  Rotate ~/.local/share/dotfiles.log

Appearance:
  theme       Switch terminal theme (dark/light)
  wallpaper   Apply a wallpaper from your library
  fonts       Install Nerd Fonts (JetBrainsMono by default)
  tune        Apply OS tuning (opt-in)

Secrets:
  secrets-init    Initialize age key for secrets
  secrets         Edit encrypted secrets (age)
  secrets-create  Create an encrypted secrets file
  ssh-key         Encrypt an SSH key locally with age

Security (opt-in):
  backup        Create a compressed backup of your home
  encrypt-check Check disk encryption status
  firewall      Apply firewall hardening
  telemetry     Disable OS telemetry
  dns-doh       Enable DNS-over-HTTPS
  lock-screen   Enforce lock screen idle settings
  usb-safety    Disable automount for removable media

Meta:
  upgrade     Update flake, plugins, and dotfiles
  packages    List installed packages and package managers
  --version   Show version information
  help        Show this help message
EOF
  fi
}

# Dispatch to command module
dispatch() {
  local module="$1"
  local cmd="$2"
  shift 2

  local src_dir
  src_dir="$(resolve_source_dir)"
  if [ -z "$src_dir" ]; then
    echo "Dotfiles source not found." >&2
    exit 1
  fi

  local module_path="$src_dir/scripts/dot/commands/$module.sh"
  if [ -f "$module_path" ]; then
    exec bash "$module_path" "$cmd" "$@"
  else
    echo "Command module not found: $module" >&2
    exit 1
  fi
}

case "$COMMAND" in
  # Version
  --version|-v|version)
    if load_ui; then
      ui_logo_dot "Dot • Version"
      ui_key_value "Version" "v${VERSION}"
      ui_key_value "Description" "Dotfiles CLI - Cross-platform shell environment distribution"
      ui_key_value "Repository" "https://github.com/sebastienrousseau/dotfiles"
      ui_key_value "Chezmoi" "$(chezmoi --version 2>/dev/null | head -1 || echo 'not installed')"
    else
      echo "dot v${VERSION}"
      echo "Dotfiles CLI - Cross-platform shell environment distribution"
      echo ""
      echo "Repository: https://github.com/sebastienrousseau/dotfiles"
      echo "Managed by: chezmoi $(chezmoi --version 2>/dev/null | head -1 || echo 'not installed')"
    fi
    exit 0
    ;;

  # Core commands
  apply|sync|update|add|diff|status|remove|cd|edit)
    dispatch "core" "$COMMAND" "$@"
    ;;

  # Diagnostics
  doctor|heal|health|health-check|security-score|rollback|restore|drift|history|benchmark)
    dispatch "diagnostics" "$COMMAND" "$@"
    ;;

  # Tools
  tools|new|packages|log-rotate)
    dispatch "tools" "$COMMAND" "$@"
    ;;

  # Appearance
  theme|wallpaper|fonts|tune)
    dispatch "appearance" "$COMMAND" "$@"
    ;;

  # Secrets
  secrets-init|secrets|secrets-create|ssh-key)
    dispatch "secrets" "$COMMAND" "$@"
    ;;

  # Security
  backup|encrypt-check|firewall|telemetry|dns-doh|lock-screen|usb-safety)
    dispatch "security" "$COMMAND" "$@"
    ;;

  # Meta
  upgrade|docs|learn|keys|sandbox|mcp)
    dispatch "meta" "$COMMAND" "$@"
    ;;

  # Help
  help|--help|-h)
    show_help
    ;;

  # Unknown or empty
  *)
    if [ -z "$COMMAND" ]; then
      show_help
    else
      echo "Unknown command: $COMMAND"
      echo "Try 'dot help' for usage."
      exit 1
    fi
    ;;
esac
