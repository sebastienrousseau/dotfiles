#!/usr/bin/env bash
set -e

# Dotfiles CLI Entry Point - v0.2.478

VERSION="0.2.478"

COMMAND="$1"
if [ -n "$1" ]; then
    shift
fi

show_help() {
    echo "Usage: dot [command]"
    echo ""
    echo "Core Commands:"
    echo "  apply       Apply dotfiles (chezmoi apply)"
    echo "  sync        Apply dotfiles (alias of apply)"
    echo "  update      Pull latest changes and apply them (chezmoi update)"
    echo "  add         Add a file to chezmoi source"
    echo "  diff        Show chezmoi diff with exclusions"
    echo "  status      Show configuration drift (chezmoi status)"
    echo "  remove      Safely remove a managed file"
    echo "  cd          Print source directory path (use: cd \$(dot cd))"
    echo "  edit        Open chezmoi source in \$EDITOR"
    echo ""
    echo "Diagnostics:"
    echo "  doctor      Check system health and configuration"
    echo "  heal        Auto-repair common dotfiles issues"
    echo "  health      Run comprehensive health check"
    echo "  rollback    Rollback dotfiles to a previous state"
    echo "  drift       Drift dashboard (detailed chezmoi status)"
    echo "  history     Shell history analysis"
    echo "  benchmark   Run shell startup benchmark"
    echo ""
    echo "Tools:"
    echo "  tools       Show or install nix packages (dot tools [install])"
    echo "  new         Create a new project from a template"
    echo "  sandbox     Launch a safe sandbox preview (Docker/Podman)"
    echo "  keys        Show keybindings catalog"
    echo "  learn       Start the interactive tour of your new tools"
    echo "  docs        Show repo README"
    echo "  log-rotate  Rotate ~/.local/share/dotfiles.log"
    echo ""
    echo "Appearance:"
    echo "  theme       Switch terminal theme (dark/light)"
    echo "  wallpaper   Apply a wallpaper from your library"
    echo "  fonts       Install Nerd Fonts (JetBrainsMono by default)"
    echo "  tune        Apply OS tuning (opt-in)"
    echo ""
    echo "Secrets:"
    echo "  secrets-init    Initialize age key for secrets"
    echo "  secrets         Edit encrypted secrets (age)"
    echo "  secrets-create  Create an encrypted secrets file"
    echo "  ssh-key         Encrypt an SSH key locally with age"
    echo ""
    echo "Security (opt-in):"
    echo "  backup        Create a compressed backup of your home"
    echo "  encrypt-check Check disk encryption status"
    echo "  firewall      Apply firewall hardening"
    echo "  telemetry     Disable OS telemetry"
    echo "  dns-doh       Enable DNS-over-HTTPS"
    echo "  lock-screen   Enforce lock screen idle settings"
    echo "  usb-safety    Disable automount for removable media"
    echo ""
    echo "Meta:"
    echo "  upgrade     Update flake, plugins, and dotfiles"
    echo "  packages    List installed packages and package managers"
    echo "  --version   Show version information"
    echo "  help        Show this help message"
}

resolve_source_dir() {
    if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -d "$CHEZMOI_SOURCE_DIR" ]; then
        echo "$CHEZMOI_SOURCE_DIR"
        return
    fi
    if [ -d "$HOME/.dotfiles" ]; then
        echo "$HOME/.dotfiles"
        return
    fi
    if [ -d "$HOME/.local/share/chezmoi" ]; then
        echo "$HOME/.local/share/chezmoi"
        return
    fi
    echo ""
}

# Generic dispatcher: resolve source dir, find script, exec it.
# Usage: run_script <relative-script-path> <not-found-label> [args...]
run_script() {
    local script_rel="$1"
    local label="$2"
    shift 2
    local src_dir
    src_dir="$(resolve_source_dir)"
    if [ -z "$src_dir" ]; then
        echo "Dotfiles source not found." >&2
        exit 1
    fi
    if [ -f "$src_dir/$script_rel" ]; then
        exec bash "$src_dir/$script_rel" "$@"
    else
        echo "$label not found." >&2
        exit 1
    fi
}

# Helper functions for packages command
show_system_package_managers() {
    if command -v brew >/dev/null 2>&1; then
        brew_version=$(brew --version | head -1)
        brew_formulae=$(brew list --formula 2>/dev/null | wc -l | tr -d ' ')
        brew_casks=$(brew list --cask 2>/dev/null | wc -l | tr -d ' ')
        echo "  Homebrew: $brew_version"
        echo "    Formulae: $brew_formulae"
        echo "    Casks: $brew_casks"
    fi
    if command -v apt >/dev/null 2>&1; then
        apt_version=$(apt --version 2>/dev/null | head -1 || echo 'installed')
        apt_packages=$(dpkg -l 2>/dev/null | grep -c '^ii' || echo 'N/A')
        echo "  APT: $apt_version"
        echo "    Packages: $apt_packages"
    fi
    if command -v dnf >/dev/null 2>&1; then
        echo "  DNF: $(dnf --version 2>/dev/null | head -1 || echo 'installed')"
    fi
    if command -v pacman >/dev/null 2>&1; then
        pacman_packages=$(pacman -Q 2>/dev/null | wc -l | tr -d ' ')
        echo "  Pacman: $(pacman --version | head -1)"
        echo "    Packages: $pacman_packages"
    fi
    if command -v nix >/dev/null 2>&1; then
        echo "  Nix: $(nix --version)"
    fi
}

show_language_package_managers() {
    if command -v npm >/dev/null 2>&1; then
        npm_globals=$(npm list -g --depth=0 2>/dev/null | grep -c '├──\|└──' || echo 'N/A')
        echo "  npm: $(npm --version)"
        echo "    Global packages: $npm_globals"
    fi
    if command -v pnpm >/dev/null 2>&1; then
        echo "  pnpm: $(pnpm --version)"
    fi
    if command -v bun >/dev/null 2>&1; then
        echo "  Bun: $(bun --version)"
    fi
    if command -v cargo >/dev/null 2>&1; then
        cargo_installed=$(cargo install --list 2>/dev/null | grep -c ':$' || echo 'N/A')
        echo "  Cargo: $(cargo --version | cut -d' ' -f2)"
        echo "    Installed: $cargo_installed"
    fi
    if command -v pip3 >/dev/null 2>&1; then
        echo "  pip: $(pip3 --version | cut -d' ' -f2)"
    fi
    if command -v pipx >/dev/null 2>&1; then
        pipx_installed=$(pipx list --short 2>/dev/null | wc -l | tr -d ' ')
        echo "  pipx: $(pipx --version)"
        echo "    Installed: $pipx_installed"
    fi
    if command -v gem >/dev/null 2>&1; then
        echo "  RubyGems: $(gem --version)"
    fi
    if command -v go >/dev/null 2>&1; then
        echo "  Go: $(go version | cut -d' ' -f3)"
    fi
}

case "$COMMAND" in
    --version|-v|version)
        echo "dot v${VERSION}"
        echo "Dotfiles CLI - Cross-platform shell environment distribution"
        echo ""
        echo "Repository: https://github.com/sebastienrousseau/dotfiles"
        echo "Managed by: chezmoi $(chezmoi --version 2>/dev/null | head -1 || echo 'not installed')"
        exit 0
        ;;
    apply)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/ops/chezmoi-apply.sh" ]; then
            exec bash "$SRC_DIR/scripts/ops/chezmoi-apply.sh" "$@"
        fi
        exec chezmoi apply
        ;;
    sync)
        exec "$0" apply "$@"
        ;;
    add)
        # Add a file to chezmoi source
        if [ -z "$1" ]; then
            echo "Usage: dot add <file>"
            echo ""
            echo "Add a file to the chezmoi source directory."
            echo "The file will be managed by chezmoi from now on."
            exit 1
        fi
        exec chezmoi add "$@"
        ;;
    status)
        # Show configuration drift
        exec chezmoi status "$@"
        ;;
    cd)
        # Print source directory path for use with: cd $(dot cd)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ]; then
            echo "$SRC_DIR"
        else
            echo "Dotfiles source not found." >&2
            exit 1
        fi
        ;;
    learn)
        # Execute the interactive tour
        exec "$(dirname "$0")/tour" "$@"
        ;;
    doctor)
        echo "Running Dotfiles Doctor..."
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/diagnostics/doctor.sh" ]; then
            exec bash "$SRC_DIR/scripts/diagnostics/doctor.sh"
        fi
        exec chezmoi doctor
        ;;
    keys)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/KEYS.md" ]; then
            if [ -n "$1" ]; then
                rg -i --fixed-strings --context 1 "$1" "$SRC_DIR/docs/KEYS.md" || true
            else
                exec cat "$SRC_DIR/docs/KEYS.md"
            fi
        else
            echo "Keybindings catalog not found."
            exit 1
        fi
        ;;
    sandbox)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if command -v docker >/dev/null; then
            echo "Launching sandbox via Docker..."
            docker build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec docker run --rm -it dotfiles-sandbox
        elif command -v podman >/dev/null; then
            echo "Launching sandbox via Podman..."
            podman build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec podman run --rm -it dotfiles-sandbox
        else
            echo "Docker or Podman is required for sandbox."
            exit 1
        fi
        ;;
    heal) run_script "scripts/ops/heal.sh" "Heal script" "$@" ;;
    health|health-check) run_script "scripts/ops/health-check.sh" "Health check script" "$@" ;;
    rollback) run_script "scripts/ops/rollback.sh" "Rollback script" "$@" ;;
    benchmark) run_script "scripts/tests/benchmark.sh" "Benchmark script" "$@" ;;
    tune)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        case "$(uname -s)" in
            Darwin)
                exec bash "$SRC_DIR/scripts/tuning/macos.sh"
                ;;
            Linux)
                exec bash "$SRC_DIR/scripts/tuning/linux.sh"
                ;;
            *)
                echo "OS tuning not supported on this platform."
                exit 1
                ;;
        esac
        ;;
    theme)     run_script "scripts/theme/switch.sh" "Theme switcher" "$@" ;;
    wallpaper) run_script "scripts/theme/wallpaper-sync.sh" "Wallpaper script" "$@" ;;
    fonts)     run_script "scripts/fonts/install-nerd-fonts.sh" "Font install script" "$@" ;;
    firewall)      run_script "scripts/security/firewall.sh" "Firewall script" "$@" ;;
    telemetry)     run_script "scripts/security/telemetry-kill.sh" "Telemetry script" "$@" ;;
    dns-doh)       run_script "scripts/security/dns-doh.sh" "DNS DoH script" "$@" ;;
    encrypt-check) run_script "scripts/security/encryption-check.sh" "Encryption check script" "$@" ;;
    lock-screen)   run_script "scripts/security/lock-screen.sh" "Lock screen script" "$@" ;;
    usb-safety)    run_script "scripts/security/usb-safety.sh" "USB safety script" "$@" ;;
    backup)        run_script "scripts/security/backup.sh" "Backup script" "$@" ;;
    ssh-key) run_script "scripts/secrets/encrypt-ssh-key.sh" "SSH key encryption script" "$@" ;;
    secrets-init)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/secrets/age-init.sh" ]; then
            exec bash "$SRC_DIR/scripts/secrets/age-init.sh"
        else
            SECRETS_DIR="$HOME/.config/chezmoi"
            KEY_FILE="$SECRETS_DIR/key.txt"
            mkdir -p "$SECRETS_DIR"
            if [ -f "$KEY_FILE" ]; then
                echo "Age key already exists: $KEY_FILE"
                exit 0
            fi
            if ! command -v age-keygen >/dev/null; then
                echo "age-keygen not found. Install 'age' first."
                exit 1
            fi
            age-keygen -o "$KEY_FILE"
            chmod 600 "$KEY_FILE"
            echo "Age key created at $KEY_FILE"
            echo "Public key:"
            age-keygen -y "$KEY_FILE"
        fi
        ;;
    secrets-create) run_script "scripts/secrets/create-secrets-file.sh" "Secrets creation script" "$@" ;;
    secrets)
        SECRETS_DIR="$HOME/.config/chezmoi"
        KEY_FILE="$SECRETS_DIR/key.txt"
        if [ ! -f "$KEY_FILE" ]; then
            echo "No age key found. Run: dot secrets-init"
            exit 1
        fi
        exec chezmoi edit --apply "$HOME/.config/chezmoi/encrypted_secrets.age"
        ;;
    upgrade)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/nix/flake.nix" ] && command -v nix >/dev/null; then
            echo "Updating Nix flake..."
            (cd "$SRC_DIR" && nix flake update) || true
            echo "Running Nix garbage collection..."
            nix-collect-garbage -d || true
        fi
        echo "Updating dotfiles..."
        chezmoi update || true
        if command -v nvim >/dev/null; then
            echo "Updating Neovim plugins..."
            nvim --headless "+Lazy! sync" +qa || true
        fi
        if [ "${DOTFILES_FONTS:-}" = "1" ]; then
            if [ -f "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh" ]; then
                echo "Installing Nerd Fonts..."
                sh "$SRC_DIR/scripts/fonts/install-nerd-fonts.sh"
            fi
        fi
        ;;
    edit)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -n "${EDITOR:-}" ]; then
            exec "$EDITOR" "$SRC_DIR"
        elif command -v nvim >/dev/null; then
            exec nvim "$SRC_DIR"
        elif command -v vim >/dev/null; then
            exec vim "$SRC_DIR"
        else
            echo "No editor found. Set $EDITOR to open $SRC_DIR."
            exit 1
        fi
        ;;
    docs)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/README.md" ]; then
            exec cat "$SRC_DIR/README.md"
        else
            echo "README not found."
            exit 1
        fi
        ;;
    update)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/ops/chezmoi-update.sh" ]; then
            exec bash "$SRC_DIR/scripts/ops/chezmoi-update.sh" "$@"
        fi
        echo "Updating Dotfiles..."
        exec chezmoi update
        ;;
    diff)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/ops/chezmoi-diff.sh" ]; then
            exec bash "$SRC_DIR/scripts/ops/chezmoi-diff.sh" "$@"
        fi
        exec chezmoi diff "$@"
        ;;
    remove) run_script "scripts/ops/chezmoi-remove.sh" "Remove helper" "$@" ;;
    drift)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/diagnostics/drift-dashboard.sh" ]; then
            exec bash "$SRC_DIR/scripts/diagnostics/drift-dashboard.sh"
        fi
        exec chezmoi status
        ;;
    history) run_script "scripts/diagnostics/history-analysis.sh" "History analysis script" "$@" ;;
    tools)
        SRC_DIR="$(resolve_source_dir)"
        SUBCOMMAND="${1:-}"
        if [ "$SUBCOMMAND" = "install" ]; then
            # Install tools via nix
            if ! command -v nix >/dev/null 2>&1; then
                echo "Nix is not installed."
                echo ""
                echo "To install Nix, run:"
                echo "  curl -L https://nixos.org/nix/install | sh"
                echo ""
                echo "Or use Homebrew/apt for individual tools."
                exit 1
            fi
            shift
            if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/nix/flake.nix" ]; then
                echo "Entering Nix development shell..."
                exec nix develop "$SRC_DIR/nix" "$@"
            else
                echo "Nix flake not found in source directory."
                exit 1
            fi
        elif [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/TOOLS.md" ]; then
            exec cat "$SRC_DIR/docs/TOOLS.md"
        elif [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/UTILS.md" ]; then
            exec cat "$SRC_DIR/docs/UTILS.md"
        else
            echo "Dot Tools:"
            echo ""
            echo "Usage: dot tools [command]"
            echo ""
            echo "Commands:"
            echo "  (none)    Show tools documentation"
            echo "  install   Enter Nix development shell with all tools"
            echo ""
            echo "Quick Reference:"
            echo "  dot sync       - Apply dotfiles"
            echo "  dot update     - Pull latest changes and apply"
            echo "  dot doctor     - Run health checks"
            echo "  dot keys       - Show keybindings catalog"
            echo "  dot learn      - Interactive tour"
        fi
        ;;
    new)
        TEMPLATE_LANG="${1:-}"
        PROJECT_NAME="${2:-}"
        if [ -z "$TEMPLATE_LANG" ] || [ -z "$PROJECT_NAME" ]; then
            echo "Usage: dot new <lang> <name>"
            echo "Available templates: python, go, node, packer, molecule"
            exit 1
        fi
        # Validate inputs to prevent path traversal
        if [[ ! "$TEMPLATE_LANG" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "Invalid template name: $TEMPLATE_LANG" >&2
            exit 1
        fi
        if [[ ! "$PROJECT_NAME" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
            echo "Invalid project name: $PROJECT_NAME" >&2
            exit 1
        fi
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        TEMPLATE_DIR="$SRC_DIR/templates/projects/$TEMPLATE_LANG"
        if [ ! -d "$TEMPLATE_DIR" ]; then
            echo "Unknown template: $TEMPLATE_LANG"
            echo "Available templates: python, go, node, packer, molecule"
            exit 1
        fi
        # Pre-flight: verify Python is available before creating any files
        PYTHON_CMD=""
        if command -v python3 >/dev/null 2>&1; then
            PYTHON_CMD="python3"
        elif command -v python >/dev/null 2>&1; then
            PYTHON_CMD="python"
        else
            echo "python3 is required to render templates." >&2
            exit 1
        fi
        DEST="$PWD/$PROJECT_NAME"
        if [ -e "$DEST" ]; then
            echo "Destination exists: $DEST"
            exit 1
        fi
        mkdir -p "$DEST"
        cp -R "$TEMPLATE_DIR/." "$DEST"
        find "$DEST" -depth -name "__PROJECT_NAME__" -print0 | while IFS= read -r -d '' path; do
            parent="$(dirname "$path")"
            mv "$path" "$parent/$PROJECT_NAME"
        done
        # Render template placeholders
        find "$DEST" -type f -print0 | while IFS= read -r -d '' file; do
            $PYTHON_CMD - "$file" "$PROJECT_NAME" <<'PY'
import sys

path = sys.argv[1]
name = sys.argv[2]
with open(path, "r", encoding="utf-8") as f:
    data = f.read()
data = data.replace("__PROJECT_NAME__", name)
with open(path, "w", encoding="utf-8") as f:
    f.write(data)
PY
        done
        echo "Created $TEMPLATE_LANG project at $DEST"
        ;;
    packages)
        echo "Package Managers:"
        echo ""
        show_system_package_managers
        echo ""
        echo "Language Package Managers:"
        show_language_package_managers
        ;;
    log-rotate) run_script "scripts/tools/log-rotate.sh" "Log rotation script" "$@" ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -z "$COMMAND" ]; then
            show_help
        else
            echo "Unknown command: $COMMAND"
            echo "Try 'dot help' for usage."
            exit 1
        fi
        ;;
esac
