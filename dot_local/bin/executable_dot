#!/usr/bin/env bash
# Dotfiles CLI Entry Point - v0.2.481
# Modular architecture with command handlers in scripts/dot/commands/

set -e

VERSION="0.2.481"

COMMAND="$1"
if [ -n "$1" ]; then
  shift
fi

# Resolve the dotfiles source directory
resolve_source_dir() {
  if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -d "$CHEZMOI_SOURCE_DIR" ]; then
    echo "$CHEZMOI_SOURCE_DIR"
    return
  fi
  if [ -d "$HOME/.dotfiles" ]; then
    echo "$HOME/.dotfiles"
    return
  fi
  if [ -d "$HOME/.local/share/chezmoi" ]; then
    echo "$HOME/.local/share/chezmoi"
    return
  fi
  echo ""
}

show_help() {
  cat <<'EOF'
Usage: dot [command]

Core Commands:
  apply       Apply dotfiles (chezmoi apply)
  sync        Apply dotfiles (alias of apply)
  update      Pull latest changes and apply them (chezmoi update)
  add         Add a file to chezmoi source
  diff        Show chezmoi diff with exclusions
  status      Show configuration drift (chezmoi status)
  remove      Safely remove a managed file
  cd          Print source directory path (use: cd $(dot cd))
  edit        Open chezmoi source in $EDITOR

Diagnostics:
  doctor         Check system health and configuration
  heal           Auto-repair common dotfiles issues
  health         Run comprehensive health dashboard
  security-score Security assessment with grading
  rollback       Rollback dotfiles to a previous state
  drift          Drift dashboard (detailed chezmoi status)
  history        Shell history analysis
  benchmark      Run shell startup benchmark (--detailed, --profile)

Tools:
  tools       Show or install nix packages (dot tools [install])
  new         Create a new project from a template
  sandbox     Launch a safe sandbox preview (Docker/Podman)
  keys        Show keybindings catalog
  learn       Start the interactive tour of your new tools
  docs        Show repo README
  log-rotate  Rotate ~/.local/share/dotfiles.log

Appearance:
  theme       Switch terminal theme (dark/light)
  wallpaper   Apply a wallpaper from your library
  fonts       Install Nerd Fonts (JetBrainsMono by default)
  tune        Apply OS tuning (opt-in)

Secrets:
  secrets-init    Initialize age key for secrets
  secrets         Edit encrypted secrets (age)
  secrets-create  Create an encrypted secrets file
  ssh-key         Encrypt an SSH key locally with age

Security (opt-in):
  backup        Create a compressed backup of your home
  encrypt-check Check disk encryption status
  firewall      Apply firewall hardening
  telemetry     Disable OS telemetry
  dns-doh       Enable DNS-over-HTTPS
  lock-screen   Enforce lock screen idle settings
  usb-safety    Disable automount for removable media

Meta:
  upgrade     Update flake, plugins, and dotfiles
  packages    List installed packages and package managers
  --version   Show version information
  help        Show this help message
EOF
}

# Dispatch to command module
dispatch() {
  local module="$1"
  local cmd="$2"
  shift 2

  local src_dir
  src_dir="$(resolve_source_dir)"
  if [ -z "$src_dir" ]; then
    echo "Dotfiles source not found." >&2
    exit 1
  fi

  local module_path="$src_dir/scripts/dot/commands/$module.sh"
  if [ -f "$module_path" ]; then
    exec bash "$module_path" "$cmd" "$@"
  else
    echo "Command module not found: $module" >&2
    exit 1
  fi
}

case "$COMMAND" in
  # Version
  --version|-v|version)
    echo "dot v${VERSION}"
    echo "Dotfiles CLI - Cross-platform shell environment distribution"
    echo ""
    echo "Repository: https://github.com/sebastienrousseau/dotfiles"
    echo "Managed by: chezmoi $(chezmoi --version 2>/dev/null | head -1 || echo 'not installed')"
    exit 0
    ;;

  # Core commands
  apply|sync|update|add|diff|status|remove|cd|edit)
    dispatch "core" "$COMMAND" "$@"
    ;;

  # Diagnostics
  doctor|heal|health|health-check|security-score|rollback|drift|history|benchmark)
    dispatch "diagnostics" "$COMMAND" "$@"
    ;;

  # Tools
  tools|new|packages|log-rotate)
    dispatch "tools" "$COMMAND" "$@"
    ;;

  # Appearance
  theme|wallpaper|fonts|tune)
    dispatch "appearance" "$COMMAND" "$@"
    ;;

  # Secrets
  secrets-init|secrets|secrets-create|ssh-key)
    dispatch "secrets" "$COMMAND" "$@"
    ;;

  # Security
  backup|encrypt-check|firewall|telemetry|dns-doh|lock-screen|usb-safety)
    dispatch "security" "$COMMAND" "$@"
    ;;

  # Meta
  upgrade|docs|learn|keys|sandbox)
    dispatch "meta" "$COMMAND" "$@"
    ;;

  # Help
  help|--help|-h)
    show_help
    ;;

  # Unknown or empty
  *)
    if [ -z "$COMMAND" ]; then
      show_help
    else
      echo "Unknown command: $COMMAND"
      echo "Try 'dot help' for usage."
      exit 1
    fi
    ;;
esac
