#!/bin/sh
set -e

# Dotfiles CLI Entry Point - v0.2.473

COMMAND="$1"
if [ -n "$1" ]; then
    shift
fi

show_help() {
    echo "Usage: dot [command]"
    echo ""
    echo "Commands:"
    echo "  sync       Apply dotfiles (chezmoi apply)"
    echo "  update     Pull latest changes and apply them (chezmoi update)"
    echo "  doctor     Check system health and configuration"
    echo "  keys       Show keybindings catalog"
    echo "  sandbox    Launch a safe sandbox preview (Docker/Podman)"
    echo "  benchmark  Run shell startup benchmark"
    echo "  tune       Apply OS tuning (opt-in)"
    echo "  secrets    Edit encrypted secrets (age)"
    echo "  secrets-init  Initialize age key for secrets"
    echo "  upgrade    Update flake, plugins, and dotfiles"
    echo "  edit       Open chezmoi source in $EDITOR"
    echo "  docs       Show repo README"
    echo "  learn      Start the interactive tour of your new tools"
    echo "  tools      Show dot utils overview"
    echo "  help       Show this help message"
}

resolve_source_dir() {
    if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -d "$CHEZMOI_SOURCE_DIR" ]; then
        echo "$CHEZMOI_SOURCE_DIR"
        return
    fi
    if [ -d "$HOME/.dotfiles" ]; then
        echo "$HOME/.dotfiles"
        return
    fi
    if [ -d "$HOME/.local/share/chezmoi" ]; then
        echo "$HOME/.local/share/chezmoi"
        return
    fi
    echo ""
}

case "$COMMAND" in
    sync)
        echo "Applying Dotfiles..."
        exec chezmoi apply
        ;;
    learn)
        # Execute the interactive tour
        exec "$(dirname "$0")/tour" "$@"
        ;;
    doctor)
        echo "Running Dotfiles Doctor..."
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/diagnostics/doctor.sh" ]; then
            exec bash "$SRC_DIR/scripts/diagnostics/doctor.sh"
        else
            exec chezmoi doctor
        fi
        ;;
    keys)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/KEYS.md" ]; then
            if [ -n "$1" ]; then
                rg -i --context 1 "$1" "$SRC_DIR/docs/KEYS.md" || true
            else
                exec cat "$SRC_DIR/docs/KEYS.md"
            fi
        else
            echo "Keybindings catalog not found."
            exit 1
        fi
        ;;
    sandbox)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if command -v docker >/dev/null; then
            echo "Launching sandbox via Docker..."
            docker build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec docker run --rm -it dotfiles-sandbox
        elif command -v podman >/dev/null; then
            echo "Launching sandbox via Podman..."
            podman build -f "$SRC_DIR/tests/Dockerfile.sandbox" -t dotfiles-sandbox "$SRC_DIR"
            exec podman run --rm -it dotfiles-sandbox
        else
            echo "Docker or Podman is required for sandbox."
            exit 1
        fi
        ;;
    benchmark)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/scripts/tests/benchmark.sh" ]; then
            exec bash "$SRC_DIR/scripts/tests/benchmark.sh"
        else
            echo "Benchmark script not found."
            exit 1
        fi
        ;;
    tune)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        case "$(uname -s)" in
            Darwin)
                exec bash "$SRC_DIR/scripts/tuning/macos.sh"
                ;;
            Linux)
                exec bash "$SRC_DIR/scripts/tuning/linux.sh"
                ;;
            *)
                echo "OS tuning not supported on this platform."
                exit 1
                ;;
        esac
        ;;
    secrets-init)
        SECRETS_DIR="$HOME/.config/chezmoi"
        KEY_FILE="$SECRETS_DIR/key.txt"
        mkdir -p "$SECRETS_DIR"
        if [ -f "$KEY_FILE" ]; then
            echo "Age key already exists: $KEY_FILE"
            exit 0
        fi
        if ! command -v age-keygen >/dev/null; then
            echo "age-keygen not found. Install 'age' first."
            exit 1
        fi
        age-keygen -o "$KEY_FILE"
        chmod 600 "$KEY_FILE"
        echo "Age key created at $KEY_FILE"
        echo "Public key:"
        age-keygen -y "$KEY_FILE"
        ;;
    secrets)
        SECRETS_DIR="$HOME/.config/chezmoi"
        KEY_FILE="$SECRETS_DIR/key.txt"
        if [ ! -f "$KEY_FILE" ]; then
            echo "No age key found. Run: dot secrets-init"
            exit 1
        fi
        exec chezmoi edit --apply "$HOME/.config/chezmoi/encrypted_secrets.age"
        ;;
    upgrade)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        if [ -f "$SRC_DIR/nix/flake.nix" ] && command -v nix >/dev/null; then
            echo "Updating Nix flake..."
            (cd "$SRC_DIR" && nix flake update) || true
        fi
        echo "Updating dotfiles..."
        chezmoi update || true
        if command -v nvim >/dev/null; then
            echo "Updating Neovim plugins..."
            nvim --headless "+Lazy! sync" +qa || true
        fi
        ;;
    edit)
        SRC_DIR="$(resolve_source_dir)"
        if [ -z "$SRC_DIR" ]; then
            echo "Dotfiles source not found."
            exit 1
        fi
        exec chezmoi edit "$SRC_DIR"
        ;;
    docs)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/README.md" ]; then
            exec cat "$SRC_DIR/README.md"
        else
            echo "README not found."
            exit 1
        fi
        ;;
    update)
        # Update dotfiles
        echo "Updating Dotfiles..."
        exec chezmoi update
        ;;
    tools)
        SRC_DIR="$(resolve_source_dir)"
        if [ -n "$SRC_DIR" ] && [ -f "$SRC_DIR/docs/UTILS.md" ]; then
            exec cat "$SRC_DIR/docs/UTILS.md"
        else
            echo "Dot Utils:"
            echo "  dot sync       - Apply dotfiles"
            echo "  dot update     - Pull latest changes and apply"
            echo "  dot doctor     - Run health checks"
            echo "  dot keys       - Show keybindings catalog"
            echo "  dot learn      - Interactive tour"
        fi
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -z "$COMMAND" ]; then
            show_help
        else
            echo "Unknown command: $COMMAND"
            echo "Try 'dot help' for usage."
            exit 1
        fi
        ;;
esac
