#!/usr/bin/env bash
## Base64 Transcoder — Encode and decode base64 with URL-safe support.
##
## Supports standard and URL-safe base64 encoding/decoding modes.
## Handles both command-line arguments and stdin input.
##
## # Requirements
## - base64: Core utility (coreutils or macOS built-in)
## - tr: For URL-safe character translation
##
## # Usage
## b64 "string"                # Encode string to base64
## b64 -d "encoded"            # Decode base64 string
## b64 -u "string"             # URL-safe encode
## b64 -d -u "encoded"         # URL-safe decode
## echo "data" | b64           # Encode from stdin
##
## # Platform Notes
## - macOS: Uses base64 -D for decode
## - Linux: Uses base64 -d for decode

set -euo pipefail

# --- UI Theme ---
CYAN='\033[38;5;86m'
PURPLE='\033[38;5;141m'
GREEN='\033[38;5;84m'
GRAY='\033[38;5;244m'
NC='\033[0m'
BOLD='\033[1m'

log_header() {
  echo -e "${BOLD}${PURPLE}󰇧 Base64 Transcoder${NC} ${GRAY}━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

usage() {
  log_header
  echo -e "Usage: b64 [options] [string]"
  echo -e "Options:"
  echo -e "  -e, --encode    ${GRAY}Encode to base64 (default)${NC}"
  echo -e "  -d, --decode    ${GRAY}Decode from base64${NC}"
  echo -e "  -u, --url       ${GRAY}URL-safe mode${NC}"
  exit 0
}

MODE="encode"
URL_SAFE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -e|--encode|encode) MODE="encode"; shift ;;
    -d|--decode|decode) MODE="decode"; shift ;;
    -u|--url) URL_SAFE=true; shift ;;
    -h|--help) usage ;;
    *) break ;;
  esac
done

INPUT="${*:-$(cat)}"

if [[ "$MODE" == "encode" ]]; then
  if $URL_SAFE; then
    echo -n "$INPUT" | base64 | tr '+/' '-_' | tr -d '='
  else
    echo -n "$INPUT" | base64
  fi
else
  if $URL_SAFE; then
    INPUT=$(echo "$INPUT" | tr '-_' '+/')
    while [[ $(( ${#INPUT} % 4 )) -ne 0 ]]; do INPUT="${INPUT}="; done
  fi
  echo "$INPUT" | base64 -d 2>/dev/null || echo "$INPUT" | base64 -D
fi
