#!/usr/bin/env bash
# git-ai-diff - AI-powered diff analysis and review
# Managed by chezmoi - https://github.com/sebastienrousseau/dotfiles
#
# Usage: git ai-diff [<commit>] [--provider <provider>]
#   <commit>: Compare against this commit (default: HEAD)
#   --provider: claude, gemini, sgpt, ollama (auto-detected if not specified)

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

PROVIDER=""
TARGET="HEAD"
STAGED_ONLY=false

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --provider|-p)
      PROVIDER="$2"
      shift 2
      ;;
    --staged|-s)
      STAGED_ONLY=true
      shift
      ;;
    --help|-h)
      echo "Usage: git ai-diff [<commit>] [--provider <provider>] [--staged]"
      echo ""
      echo "Options:"
      echo "  <commit>        Compare against this commit (default: HEAD)"
      echo "  --provider, -p  AI provider: claude, gemini, sgpt, ollama, aider"
      echo "  --staged, -s    Review only staged changes"
      echo ""
      echo "Environment:"
      echo "  GIT_AI_PROVIDER  Default AI provider"
      exit 0
      ;;
    -*)
      echo -e "${RED}Unknown option: $1${NC}"
      exit 1
      ;;
    *)
      TARGET="$1"
      shift
      ;;
  esac
done

# Auto-detect provider if not specified
detect_provider() {
  if [[ -n "${GIT_AI_PROVIDER:-}" ]]; then
    echo "$GIT_AI_PROVIDER"
  elif command -v claude >/dev/null 2>&1; then
    echo "claude"
  elif command -v aider >/dev/null 2>&1; then
    echo "aider"
  elif command -v gemini >/dev/null 2>&1; then
    echo "gemini"
  elif command -v sgpt >/dev/null 2>&1; then
    echo "sgpt"
  elif command -v ollama >/dev/null 2>&1; then
    echo "ollama"
  else
    echo ""
  fi
}

PROVIDER="${PROVIDER:-$(detect_provider)}"

if [[ -z "$PROVIDER" ]]; then
  echo -e "${RED}Error: No AI provider found. Install claude, gemini, sgpt, aider, or ollama.${NC}"
  exit 1
fi

# Get the diff
if [[ "$STAGED_ONLY" == "true" ]]; then
  DIFF=$(git diff --cached)
  DIFF_STAT=$(git diff --cached --stat)
  CONTEXT="staged changes"
else
  DIFF=$(git diff "$TARGET")
  DIFF_STAT=$(git diff "$TARGET" --stat)
  CONTEXT="changes compared to $TARGET"
fi

if [[ -z "$DIFF" ]]; then
  echo -e "${YELLOW}No changes to review.${NC}"
  exit 0
fi

echo -e "${BLUE}Analyzing ${CONTEXT} using ${PROVIDER}...${NC}"
echo ""
echo -e "${CYAN}Changed files:${NC}"
echo "$DIFF_STAT"
echo ""

# Prompt for diff analysis
PROMPT="You are an expert code reviewer. Analyze the following git diff and provide:

1. **Summary**: Brief overview of what changed (2-3 sentences)
2. **Key Changes**: Bullet points of important modifications
3. **Potential Issues**: Any bugs, security issues, or code smells you notice
4. **Suggestions**: Improvements or best practices to consider
5. **Risk Level**: Low/Medium/High with brief justification

Be concise but thorough. Focus on actionable feedback.

Diff:
\`\`\`diff
$DIFF
\`\`\`"

# Generate analysis based on provider
case "$PROVIDER" in
  claude)
    ANALYSIS=$(echo "$PROMPT" | claude --print 2>/dev/null || echo "")
    ;;
  aider)
    ANALYSIS=$(aider --message "$PROMPT" --no-git --yes 2>/dev/null | tail -50 || echo "")
    ;;
  gemini)
    ANALYSIS=$(echo "$PROMPT" | gemini 2>/dev/null || echo "")
    ;;
  sgpt)
    ANALYSIS=$(sgpt "$PROMPT" 2>/dev/null || echo "")
    ;;
  ollama)
    MODEL="${OLLAMA_MODEL:-llama3.2}"
    ANALYSIS=$(echo "$PROMPT" | ollama run "$MODEL" 2>/dev/null || echo "")
    ;;
  *)
    echo -e "${RED}Unknown provider: $PROVIDER${NC}"
    exit 1
    ;;
esac

if [[ -z "$ANALYSIS" ]]; then
  echo -e "${RED}Failed to analyze diff.${NC}"
  exit 1
fi

echo -e "${GREEN}=== AI Code Review ===${NC}"
echo ""
echo "$ANALYSIS"
echo ""
echo -e "${GREEN}=== End Review ===${NC}"
