#!/usr/bin/env bash
# Update all system packages and tools
# Usage: update [--all|--brew|--apt|--npm|--cargo|--pip]

set -euo pipefail

CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_section() { echo -e "\n${CYAN}━━━ $1 ━━━${NC}"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_skip() { echo -e "${YELLOW}○${NC} $1 (skipped)"; }

# Parse arguments
UPDATE_ALL=true
UPDATE_BREW=false
UPDATE_APT=false
UPDATE_NPM=false
UPDATE_CARGO=false
UPDATE_PIP=false

for arg in "$@"; do
  case "$arg" in
    --all) UPDATE_ALL=true ;;
    --brew) UPDATE_BREW=true; UPDATE_ALL=false ;;
    --apt) UPDATE_APT=true; UPDATE_ALL=false ;;
    --npm) UPDATE_NPM=true; UPDATE_ALL=false ;;
    --cargo) UPDATE_CARGO=true; UPDATE_ALL=false ;;
    --pip) UPDATE_PIP=true; UPDATE_ALL=false ;;
  esac
done

# Homebrew (macOS/Linux)
if $UPDATE_ALL || $UPDATE_BREW; then
  if command -v brew >/dev/null 2>&1; then
    log_section "Homebrew"
    brew update
    brew upgrade
    brew cleanup
    log_success "Homebrew updated"
  else
    $UPDATE_BREW && log_skip "Homebrew not installed"
  fi
fi

# APT (Debian/Ubuntu)
if $UPDATE_ALL || $UPDATE_APT; then
  if command -v apt >/dev/null 2>&1; then
    log_section "APT"
    sudo apt update
    sudo apt upgrade -y
    sudo apt autoremove -y
    log_success "APT packages updated"
  else
    $UPDATE_APT && log_skip "APT not available"
  fi
fi

# NPM global packages
if $UPDATE_ALL || $UPDATE_NPM; then
  if command -v npm >/dev/null 2>&1; then
    log_section "NPM"
    npm update -g
    log_success "NPM packages updated"
  else
    $UPDATE_NPM && log_skip "NPM not installed"
  fi
fi

# Cargo (Rust)
if $UPDATE_ALL || $UPDATE_CARGO; then
  if command -v cargo >/dev/null 2>&1; then
    log_section "Cargo"
    if command -v cargo-install-update >/dev/null 2>&1; then
      cargo install-update -a
    else
      echo "  Install cargo-update for automatic updates: cargo install cargo-update"
    fi
    rustup update stable 2>/dev/null || true
    log_success "Rust toolchain updated"
  else
    $UPDATE_CARGO && log_skip "Cargo not installed"
  fi
fi

# Pip (Python)
if $UPDATE_ALL || $UPDATE_PIP; then
  if command -v pip3 >/dev/null 2>&1; then
    log_section "Pip"
    pip3 list --outdated --format=json | python3 -c "import json,sys; print('\n'.join([p['name'] for p in json.load(sys.stdin)]))" 2>/dev/null | xargs -n1 pip3 install -U 2>/dev/null || true
    log_success "Pip packages updated"
  else
    $UPDATE_PIP && log_skip "Pip not installed"
  fi
fi

# Chezmoi (dotfiles)
if $UPDATE_ALL; then
  if command -v chezmoi >/dev/null 2>&1; then
    log_section "Dotfiles"
    chezmoi update --apply=false 2>/dev/null || true
    log_success "Dotfiles checked"
  fi
fi

echo -e "\n${GREEN}Update complete!${NC}"
