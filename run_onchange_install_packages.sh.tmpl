#!/usr/bin/env bash

# shellcheck shell=bash
# run_onchange_install_packages.sh.tmpl
# This script runs whenever its content changes (e.g., when you update the list of packages).

# Strict error handling
set -euo pipefail

log_info() { echo -e "\n[INFO] $*"; }
log_error() { echo -e "\n[ERROR] $*" >&2; }

log_info "Starting package installation/update..."

{{- if eq .chezmoi.os "darwin" }}
# macOS: Use Homebrew
echo "ï£¿ macOS detected. Checking Homebrew packages..."

if ! command -v brew >/dev/null; then
  echo "Homebrew not found. Installing..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Brewfile hash: {{ include "dot_config/dotfiles/Brewfile" | sha256sum }}
if [ -f "$HOME/.config/dotfiles/Brewfile" ]; then
  echo "Installing packages from Brewfile..."
  brew bundle --file="$HOME/.config/dotfiles/Brewfile"
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: Use apt-get (assuming Debian/Ubuntu for now)
echo "ðŸ§ Linux detected. Updating packages..."

if command -v apt-get >/dev/null; then
  sudo apt-get update
  # Add your packages here
  # packages=(
  #   curl
  #   git
  #   zsh
  # )
  # sudo apt-get install -y "${packages[@]}"
fi

{{- else if eq .chezmoi.os "windows" }}
# Windows: Use winget
echo "ðŸªŸ Windows detected. Checking winget..."
# winget import ...
{{- end }}

# Vim-Plug Installation (Universal)
if [ ! -f "$HOME/.vim/autoload/plug.vim" ]; then
    echo "Installing vim-plug..."
    curl -fLo "$HOME/.vim/autoload/plug.vim" --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
fi

# Vim Plugins Install/Update
# This hash triggers re-run when .vimrc changes: {{ include "dot_vimrc" | sha256sum }}
if command -v vim >/dev/null; then
    log_info "Updating Vim plugins..."
    vim -es -u "$HOME/.vimrc" -i NONE -c "PlugInstall" -c "PlugClean!" -c "qa"
fi

log_info "Package installation completed successfully!"
