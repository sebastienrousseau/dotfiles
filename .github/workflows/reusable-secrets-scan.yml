name: Reusable Secrets Scan

on:
  workflow_call:
    inputs:
      run_guard:
        description: Run gitleaks checkout guard script.
        required: false
        default: true
        type: boolean
      run_additional_patterns:
        description: Run additional shell/config secret pattern checks.
        required: false
        default: false
        type: boolean
    secrets:
      github_token:
        required: false

permissions:
  contents: read

jobs:
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          # Secrets scanning should validate current tree state only.
          fetch-depth: 1
          fetch-tags: false

      - name: Guard gitleaks history mode
        if: inputs.run_guard == true
        run: bash scripts/ci/guard-gitleaks-checkout.sh

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        env:
          GITHUB_TOKEN: ${{ secrets.github_token || github.token }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Additional secret patterns
        if: inputs.run_additional_patterns == true
        run: |
          echo "Running additional security patterns scan..."
          rg -i "api[_-]?key|secret|password|token" --type sh || true
          ! rg -i "(password|secret|key)\s*[:=]\s*['\"][^'\"]{8,}" dot_config/ || {
            echo "Potential hardcoded credentials found in config files"
            exit 1
          }
          echo "Additional security scan completed"
