name: Compliance Guard

# SOC 2 / ISO 27001 compliance checks for security and portability
# Blocks insecure patterns and enforces cross-platform compatibility
# Verifies cryptographic identity (ALCOA: Attributable)

on:
  pull_request:
    branches: [master]
  merge_group:
    branches: [master]
  push:
    branches: [master]
    paths:
      - '**.sh'
      - '**.bash'
      - '**.zsh'
      - '**.tmpl'
      - 'Dockerfile*'
      - '.gitattributes'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Commit Signature Verification (ALCOA: Attributable)
  # ============================================================================
  verify-signatures:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only run on pull requests
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout with full history
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Import GPG keys from GitHub
        run: |
          # Import GitHub's web-flow signing key for web commits
          curl -sL https://github.com/web-flow.gpg | gpg --import 2>/dev/null || true

      - name: Verify commit signatures
        id: verify
        run: |
          echo "## Commit Signature Verification" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Checking commits from $BASE_SHA to $HEAD_SHA"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Commit | Author | Signature |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|--------|-----------|" >> "$GITHUB_STEP_SUMMARY"

          unsigned_count=0
          signed_count=0

          for commit in $(git rev-list "$BASE_SHA".."$HEAD_SHA"); do
            author=$(git log -1 --format='%an' "$commit")
            short_sha=$(git log -1 --format='%h' "$commit")

            # Check for GPG/SSH signature status.
            # Note: SSH signatures report "N" unless allowedSignersFile is configured.
            sig_status=$(git log -1 --format='%G?' "$commit" 2>/dev/null || echo "N")
            has_sig_header="false"
            if git cat-file -p "$commit" | grep -q '^gpgsig '; then
              has_sig_header="true"
            fi

            case "$sig_status" in
              G|U)
                # G = Good signature, U = Good signature with unknown validity
                signer=$(git log -1 --format='%GS' "$commit" 2>/dev/null || echo "unknown")
                echo "| \`$short_sha\` | $author | :white_check_mark: Signed by $signer |" >> "$GITHUB_STEP_SUMMARY"
                signed_count=$((signed_count + 1))
                ;;
              B)
                # B = Bad signature
                echo "| \`$short_sha\` | $author | :x: Bad signature |" >> "$GITHUB_STEP_SUMMARY"
                unsigned_count=$((unsigned_count + 1))
                ;;
              E)
                # E = Cannot check signature (missing key)
                echo "| \`$short_sha\` | $author | :warning: Unverifiable (key not found) |" >> "$GITHUB_STEP_SUMMARY"
                # Count as signed if we can't verify (might be SSH signed)
                ;;
              N|*)
                # N = No verifiable signature in current trust context.
                # If commit contains a signature block, treat as signed-but-unverified.
                if [[ "$has_sig_header" == "true" ]]; then
                  echo "| \`$short_sha\` | $author | :warning: Signed (unverified in CI trust context) |" >> "$GITHUB_STEP_SUMMARY"
                  signed_count=$((signed_count + 1))
                else
                  echo "| \`$short_sha\` | $author | :x: Unsigned |" >> "$GITHUB_STEP_SUMMARY"
                  unsigned_count=$((unsigned_count + 1))
                fi
                ;;
            esac
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Summary:** $signed_count signed, $unsigned_count unsigned" >> "$GITHUB_STEP_SUMMARY"

          if [[ $unsigned_count -gt 0 ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo ":warning: **Warning:** This PR contains unsigned commits." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "For SOC 2 / ALCOA compliance, all commits should be cryptographically signed." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "To enable signing:" >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`bash" >> "$GITHUB_STEP_SUMMARY"
            echo "# SSH signing (recommended)" >> "$GITHUB_STEP_SUMMARY"
            echo "git config --global gpg.format ssh" >> "$GITHUB_STEP_SUMMARY"
            echo "git config --global user.signingkey ~/.ssh/id_ed25519.pub" >> "$GITHUB_STEP_SUMMARY"
            echo "git config --global commit.gpgsign true" >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"

            echo "::warning::PR contains $unsigned_count unsigned commit(s). See job summary for details."
            echo "unsigned=$unsigned_count" >> "$GITHUB_OUTPUT"
          else
            echo ":white_check_mark: All commits are cryptographically signed." >> "$GITHUB_STEP_SUMMARY"
            echo "unsigned=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Signature enforcement (required)
        run: |
          echo "Signature verification complete (required mode)"
          if [[ "${{ steps.verify.outputs.unsigned }}" -gt 0 ]]; then
            echo "::error::Unsigned commits are not allowed"
            exit 1
          fi

  # ============================================================================
  # Insecure Pattern Scanner
  # ============================================================================
  insecure-patterns:
    name: Scan for Insecure Patterns
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check for insecure curl flags
        run: |
          echo "Scanning for insecure curl commands..."
          VIOLATIONS=""

          # Pattern: curl -k or curl --insecure (disables TLS verification)
          if grep -rn --include="*.sh" --include="*.bash" --include="*.zsh" --include="*.tmpl" \
               -E '(^|[[:space:]])curl([[:space:]][^|;#]*)?[[:space:]](--insecure|-k)([[:space:]]|$)' . 2>/dev/null | grep -v "^Binary"; then
            VIOLATIONS="${VIOLATIONS}Found curl with -k/--insecure flag (disables TLS verification)\n"
          fi

          # Pattern: wget --no-check-certificate
          if grep -rn --include="*.sh" --include="*.bash" --include="*.zsh" --include="*.tmpl" \
               -E 'wget\s+[^|;]*--no-check-certificate' . 2>/dev/null | grep -v "^Binary"; then
            VIOLATIONS="${VIOLATIONS}Found wget with --no-check-certificate flag\n"
          fi

          # Pattern: curl without https (http://)
          if grep -rn --include="*.sh" --include="*.bash" --include="*.zsh" --include="*.tmpl" \
               -E "curl[[:space:]][^|;#]*http://" . 2>/dev/null | grep -v "^Binary" | grep -Ev 'http://(localhost|127\.0\.0\.1)'; then
            VIOLATIONS="${VIOLATIONS}Found curl using http:// instead of https://\n"
          fi

          if [[ -n "$VIOLATIONS" ]]; then
            echo "::error::TLS Security Violations Found"
            echo -e "$VIOLATIONS"
            echo ""
            echo "Fix: Remove -k/--insecure flags and use https:// URLs"
            exit 1
          fi

          echo "No insecure TLS patterns found"

      - name: Check for hardcoded credentials patterns
        run: |
          echo "Scanning for potential hardcoded credentials..."
          VIOLATIONS=""

          # Pattern: password=, secret=, api_key= with literal values
          if grep -rn --include="*.sh" --include="*.bash" --include="*.zsh" \
               -iE "(password|secret|api_key|apikey|token)\s*=\s*['\"][^$\{]" . 2>/dev/null \
               | grep -v "example" | grep -v "placeholder" | grep -v "^Binary"; then
            VIOLATIONS="${VIOLATIONS}Potential hardcoded credentials found\n"
          fi

          if [[ -n "$VIOLATIONS" ]]; then
            echo "::warning::Potential credential patterns detected - please verify"
            echo -e "$VIOLATIONS"
          fi

          echo "Credential scan complete"

      - name: Check for dangerous chmod patterns
        run: |
          echo "Scanning for dangerous permission patterns..."

          # Pattern: chmod 777 or chmod -R 777 (world-writable)
          if grep -rn --include="*.sh" --include="*.bash" --include="*.zsh" \
               -E 'chmod\s+(-R\s+)?777' . 2>/dev/null | grep -v "^Binary" | grep -v "#"; then
            echo "::error::Found chmod 777 (world-writable) - security risk"
            exit 1
          fi

          # Pattern: chmod 666 (world-writable files)
          if grep -rn --include="*.sh" --include="*.bash" --include="*.zsh" \
               -E 'chmod\s+(-R\s+)?666' . 2>/dev/null | grep -v "^Binary" | grep -v "#"; then
            echo "::error::Found chmod 666 (world-writable) - security risk"
            exit 1
          fi

          echo "No dangerous permission patterns found"

  # ============================================================================
  # Cross-Platform Portability Check
  # ============================================================================
  portability:
    name: Cross-Platform Portability
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck with portability warnings
        run: |
          echo "Running ShellCheck for portability..."

          # Find all shell scripts and run shellcheck
          find . -name "*.sh" -type f ! -path "*/tests/*" ! -path "./.git/*" -print0 | \
            xargs -0 -r shellcheck -S warning -e SC1090,SC1091,SC2034 --format=gcc || {
              echo "::warning::ShellCheck found issues - review above"
            }

          echo "ShellCheck complete"

      - name: Check for hardcoded user paths
        run: |
          echo "Scanning for hardcoded user paths..."

          # Pattern: /home/username/ or /Users/username/ (not /home/linuxbrew)
          if grep -rn --include="*.sh" --include="*.bash" --include="*.zsh" \
               -E '/home/[a-z]+[a-z0-9_-]*/|/Users/[A-Za-z]+/' . 2>/dev/null \
               | grep -v "linuxbrew" | grep -v "sandbox" | grep -v ".git" \
               | grep -v "tests/" | grep -v "^Binary"; then
            echo "::warning::Hardcoded user paths found - consider using \$HOME or ~"
          fi

          echo "Path check complete"

      - name: Verify .gitattributes line endings
        run: |
          echo "Checking .gitattributes configuration..."

          if [[ ! -f .gitattributes ]]; then
            echo "::error::.gitattributes file missing"
            exit 1
          fi

          # Check for text=auto
          if ! grep -q "text=auto" .gitattributes; then
            echo "::error::.gitattributes missing 'text=auto' for line ending normalization"
            exit 1
          fi

          # Check for shell script LF enforcement
          if ! grep -qE '^\*\.sh.*eol=lf' .gitattributes; then
            echo "::error::.gitattributes missing LF enforcement for .sh files"
            exit 1
          fi

          echo ".gitattributes properly configured"

  # ============================================================================
  # Dockerfile Linting (Hadolint)
  # ============================================================================
  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only run if Dockerfiles exist
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check for Dockerfiles
        id: check-dockerfiles
        run: |
          if find . -name "Dockerfile*" -type f | grep -q .; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Hadolint
        if: steps.check-dockerfiles.outputs.found == 'true'
        run: |
          set -euo pipefail
          mapfile -t dockerfiles < <(find . -type f -name "Dockerfile*" ! -path "./.git/*" | sort)

          for dockerfile in "${dockerfiles[@]}"; do
            echo "Linting $dockerfile"
            docker run --rm -i hadolint/hadolint:v2.12.0-alpine \
              hadolint \
              -t warning \
              --ignore DL3008 \
              --ignore DL3013 \
              --ignore DL3018 \
              --ignore DL4006 \
              - < "$dockerfile"
          done

      - name: Skip - No Dockerfiles
        if: steps.check-dockerfiles.outputs.found == 'false'
        run: echo "No Dockerfiles found - skipping"

  # ============================================================================
  # Summary Report
  # ============================================================================
  compliance-summary:
    name: Compliance Summary
    runs-on: ubuntu-latest
    needs: [verify-signatures, insecure-patterns, portability, dockerfile-lint]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Compliance Guard Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status | ALCOA |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|-------|" >> "$GITHUB_STEP_SUMMARY"

          # Signature verification (may be skipped on push events)
          if [[ "${{ needs.verify-signatures.result }}" == "success" ]]; then
            echo "| Commit Signatures | :white_check_mark: Pass | Attributable |" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${{ needs.verify-signatures.result }}" == "skipped" ]]; then
            echo "| Commit Signatures | :white_circle: Skipped | Attributable |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Commit Signatures | :warning: Warning | Attributable |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "${{ needs.insecure-patterns.result }}" == "success" ]]; then
            echo "| TLS Security Patterns | :white_check_mark: Pass | Accurate |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| TLS Security Patterns | :x: Fail | Accurate |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "${{ needs.portability.result }}" == "success" ]]; then
            echo "| Cross-Platform Portability | :white_check_mark: Pass | Legible |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Cross-Platform Portability | :x: Fail | Legible |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "${{ needs.dockerfile-lint.result }}" == "success" ]]; then
            echo "| Dockerfile Lint | :white_check_mark: Pass | Original |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Dockerfile Lint | :x: Fail | Original |" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ALCOA Compliance" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Principle | Control |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|---------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **A**ttributable | Cryptographic commit signatures (GPG/SSH) |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **L**egible | Cross-platform compatibility verified |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **C**ontemporaneous | Git timestamps, CI audit logs |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **O**riginal | Immutable git history, signed commits |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **A**ccurate | TLS enforcement, secrets scanning |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "_Compliance Guard enforces SOC 2 / ISO 27001 / ALCOA security controls_" >> "$GITHUB_STEP_SUMMARY"
