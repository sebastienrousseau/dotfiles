name: Nightly Extended Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # For creating issues on dependency updates
  pull-requests: write  # For creating dependency update PRs

# Allow only one nightly run at a time
concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: true

env:
  CHEZMOI_VERSION: "2.47.1"

jobs:
  # ============================================================================
  # DEPENDENCY MONITORING
  # ============================================================================
  dependency-updates:
    name: Dependency Updates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check Chezmoi updates
        id: chezmoi
        run: |
          echo "Checking for Chezmoi updates..."
          CURRENT_VERSION="${{ env.CHEZMOI_VERSION }}"

          # Get latest version from GitHub API
          LATEST_VERSION=$(curl -s https://api.github.com/repos/twpayne/chezmoi/releases/latest | \
            jq -r '.tag_name' | sed 's/v//')

          echo "Current: $CURRENT_VERSION"
          echo "Latest:  $LATEST_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          if [[ "$CURRENT_VERSION" != "$LATEST_VERSION" ]]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Chezmoi update available: $CURRENT_VERSION ‚Üí $LATEST_VERSION"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Chezmoi is up to date"
          fi

      - name: Check tool updates
        run: |
          echo "Checking for tool updates..."

          # Check shellcheck
          SHELLCHECK_CURRENT=$(grep "koalaman/shellcheck-precommit" config/pre-commit-config.yaml | \
            awk -F'v' '{print $2}')
          SHELLCHECK_LATEST=$(curl -s https://api.github.com/repos/koalaman/shellcheck/releases/latest | \
            jq -r '.tag_name' | sed 's/v//')

          echo "Shellcheck: $SHELLCHECK_CURRENT ‚Üí $SHELLCHECK_LATEST"

          # Check shfmt
          SHFMT_CURRENT=$(grep -A1 "scop/pre-commit-shfmt" config/pre-commit-config.yaml | \
            grep "rev:" | awk -F'v' '{print $2}' | sed 's/-.*$//')
          SHFMT_LATEST=$(curl -s https://api.github.com/repos/mvdan/sh/releases/latest | \
            jq -r '.tag_name' | sed 's/v//')

          echo "Shfmt: $SHFMT_CURRENT ‚Üí $SHFMT_LATEST"

          # Create issues for outdated dependencies
          if [[ "$SHELLCHECK_CURRENT" != "$SHELLCHECK_LATEST" ]] || \
             [[ "$SHFMT_CURRENT" != "$SHFMT_LATEST" ]] || \
             [[ "${{ steps.chezmoi.outputs.update_available }}" == "true" ]]; then
            echo "Creating dependency update issue..."

            # Note: This would create an issue in a real implementation
            # For demo purposes, just log the updates needed
            echo "üì¶ Dependency updates available:" > dependency_updates.md
            echo "" >> dependency_updates.md
            echo "- Chezmoi: ${{ steps.chezmoi.outputs.current_version }} ‚Üí ${{ steps.chezmoi.outputs.latest_version }}" >> dependency_updates.md
            echo "- Shellcheck: $SHELLCHECK_CURRENT ‚Üí $SHELLCHECK_LATEST" >> dependency_updates.md
            echo "- Shfmt: $SHFMT_CURRENT ‚Üí $SHFMT_LATEST" >> dependency_updates.md

            cat dependency_updates.md
          fi

      - name: Upload dependency report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dependency-report-${{ github.run_number }}
          path: dependency_updates.md
          retention-days: 30

  # ============================================================================
  # EXTENDED COMPATIBILITY TESTING
  # ============================================================================
  extended-os-matrix:
    name: Extended OS Testing (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, macos-13]  # Include older macOS
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Cache Chezmoi
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.local/bin/chezmoi
          key: chezmoi-${{ runner.os }}-${{ env.CHEZMOI_VERSION }}

      - name: Setup Chezmoi
        run: |
          if [[ ! -x "$HOME/.local/bin/chezmoi" ]]; then
            bash scripts/ci/install-chezmoi-verified.sh "${{ env.CHEZMOI_VERSION }}" "$HOME/.local/bin"
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Extended compatibility test
        run: |
          echo "Testing on ${{ matrix.os }}..."

          # Test init and dry run
          chezmoi init
          chezmoi apply --verbose --dry-run

          # Test specific OS compatibility
          case "${{ runner.os }}" in
            "Linux")
              echo "Testing Linux-specific features..."
              # Test package manager detection
              command -v apt-get || command -v yum || command -v pacman || true
              ;;
            "macOS")
              echo "Testing macOS-specific features..."
              # Test Homebrew compatibility
              which brew || echo "Homebrew not installed"
              ;;
          esac

          echo "‚úÖ Extended compatibility test passed on ${{ matrix.os }}"

  # ============================================================================
  # BETA/NIGHTLY TOOL TESTING
  # ============================================================================
  beta-tools-test:
    name: Beta/Nightly Tools Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Beta tools may fail
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Test with latest shellcheck
        run: |
          echo "Testing with latest shellcheck version..."

          # Install latest shellcheck
          wget -qO- https://github.com/koalaman/shellcheck/releases/latest/download/shellcheck-latest.linux.x86_64.tar.xz | \
            tar -xJf - --strip-components=1 -C /tmp shellcheck-latest/shellcheck

          # Test with latest version
          echo "Running shellcheck latest version..."
          /tmp/shellcheck --version

          # Run on sample files (continue on error for beta compatibility)
          find scripts -name "*.sh" -type f | head -5 | xargs /tmp/shellcheck || {
            echo "‚ö†Ô∏è Latest shellcheck found issues - may be new checks"
          }

          echo "‚úÖ Beta shellcheck testing completed"

      - name: Test with development shfmt
        run: |
          echo "Testing with Go-built shfmt..."

          # Install Go and build latest shfmt
          sudo apt-get update && sudo apt-get install -y golang-go
          go install mvdan.cc/sh/v3/cmd/shfmt@latest

          echo "Running development shfmt..."
          ~/go/bin/shfmt -version

          # Test on sample files
          find scripts -name "*.sh" -type f | head -3 | xargs ~/go/bin/shfmt -d -i 2 -ci || {
            echo "‚ö†Ô∏è Development shfmt detected formatting differences"
          }

          echo "‚úÖ Development shfmt testing completed"

  # ============================================================================
  # EXTENDED SECURITY SCANNING
  # ============================================================================
  security-extended:
    name: Extended Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Advanced secret scanning
        run: |
          echo "Running advanced secret detection..."

          # Install truffleHog for additional secret detection
          docker pull trufflesecurity/trufflehog:latest

          # Scan git history (limited to avoid timeout)
          timeout 300 docker run --rm -v "$(pwd):/src" trufflesecurity/trufflehog:latest \
            git file:///src --only-verified --fail || {
            echo "‚ö†Ô∏è Trufflehog scan timed out or found issues"
          }

          echo "‚úÖ Advanced secret scanning completed"

      - name: Supply chain analysis
        run: |
          echo "Analyzing supply chain dependencies..."

          # Extract all external URLs from shell scripts
          rg -o "https?://[a-zA-Z0-9.-]+[^\\s\"']*" scripts/ --type sh | \
            sort -u > external_deps.txt || true

          echo "External dependencies found:"
          cat external_deps.txt || true

          # Check domain reputation (simplified check)
          while IFS= read -r url; do
            domain=$(echo "$url" | sed -E 's|https?://([^/]+).*|\1|')
            echo "Checking domain: $domain"

            # Simple reputation check via DNS resolution
            dig +short "$domain" > /dev/null || {
              echo "‚ö†Ô∏è Domain resolution failed: $domain"
            }
          done < external_deps.txt || true

          echo "‚úÖ Supply chain analysis completed"

      - name: Upload security artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-extended-${{ github.run_number }}
          path: |
            external_deps.txt
          retention-days: 30

  # ============================================================================
  # PERFORMANCE REGRESSION TRACKING
  # ============================================================================
  performance-tracking:
    name: Performance Regression Tracking
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y zsh hyperfine jq

      - name: Setup environment
        run: |
          bash scripts/ci/install-chezmoi-verified.sh "${{ env.CHEZMOI_VERSION }}" "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          mkdir -p "$HOME/.config/chezmoi"
          echo "sourceDir = \"$PWD\"" > "$HOME/.config/chezmoi/chezmoi.toml"
          chezmoi apply --exclude=scripts

      - name: Extended performance benchmarking
        run: |
          mkdir -p benchmark-history

          echo "Running extended performance benchmarks..."

          # Shell startup benchmark
          hyperfine --warmup 5 --runs 20 "zsh -i -c exit" \
            --export-json benchmark-history/shell-startup.json \
            --export-markdown benchmark-history/shell-startup.md

          # Chezmoi performance benchmark
          hyperfine --warmup 3 --runs 10 "chezmoi apply --dry-run" \
            --export-json benchmark-history/chezmoi-apply.json

          # Extract metrics and check thresholds
          STARTUP_TIME=$(jq '.results[0].mean * 1000 | floor' benchmark-history/shell-startup.json)
          CHEZMOI_TIME=$(jq '.results[0].mean * 1000 | floor' benchmark-history/chezmoi-apply.json)

          echo "Performance Results:"
          echo "- Shell startup: ${STARTUP_TIME}ms"
          echo "- Chezmoi apply: ${CHEZMOI_TIME}ms"

          # Create performance report
          cat > benchmark-history/report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "performance": {
              "shell_startup_ms": $STARTUP_TIME,
              "chezmoi_apply_ms": $CHEZMOI_TIME,
              "thresholds": {
                "shell_startup_max": 500,
                "chezmoi_apply_max": 2000
              }
            }
          }
          EOF

          # Check for regressions
          if [[ $STARTUP_TIME -gt 500 ]]; then
            echo "::warning::Shell startup regression: ${STARTUP_TIME}ms > 500ms"
          fi

          if [[ $CHEZMOI_TIME -gt 2000 ]]; then
            echo "::warning::Chezmoi performance regression: ${CHEZMOI_TIME}ms > 2000ms"
          fi

      - name: Upload performance history
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: performance-history-${{ github.run_number }}
          path: benchmark-history/
          retention-days: 90

  # ============================================================================
  # NIGHTLY SUMMARY REPORT
  # ============================================================================
  nightly-summary:
    name: Nightly Summary Report
    runs-on: ubuntu-latest
    needs: [dependency-updates, extended-os-matrix, beta-tools-test, security-extended, performance-tracking]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# üåô Nightly Test Summary" > summary.md
          echo "" >> summary.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> summary.md
          echo "**Commit:** ${{ github.sha }}" >> summary.md
          echo "" >> summary.md

          echo "## Job Results" >> summary.md
          echo "" >> summary.md
          echo "| Job | Status |" >> summary.md
          echo "|-----|--------|" >> summary.md
          echo "| Dependency Updates | ${{ needs.dependency-updates.result }} |" >> summary.md
          echo "| Extended OS Testing | ${{ needs.extended-os-matrix.result }} |" >> summary.md
          echo "| Beta Tools Testing | ${{ needs.beta-tools-test.result }} |" >> summary.md
          echo "| Extended Security | ${{ needs.security-extended.result }} |" >> summary.md
          echo "| Performance Tracking | ${{ needs.performance-tracking.result }} |" >> summary.md
          echo "" >> summary.md

          # Add summary to workflow summary
          cat summary.md >> $GITHUB_STEP_SUMMARY

          echo "Nightly testing completed at $(date -u)"

      - name: Upload summary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: nightly-summary-${{ github.run_number }}
          path: summary.md
          retention-days: 30
