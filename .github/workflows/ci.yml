name: CI

on:
  push:
    branches: [master]
    tags: ['v*.*.*']
  pull_request:
    branches: [master]
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday 6 AM UTC

permissions:
  contents: read

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CHEZMOI_VERSION: "2.47.1"

jobs:
  # ============================================================================
  # STAGE 1: LINT (Fast, parallel checks)
  # ============================================================================
  lint-shell:
    name: Lint / Shell
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck ripgrep
          curl -sS https://webi.sh/shfmt | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Shellcheck
        run: |
          # Exclude info-level warnings that are false positives
          # SC1091: Not following sourced files (expected, files don't exist in CI)
          # SC2030: Modification of VAR is local (intentional in test subshells)
          # SC2031: VAR was modified in a subshell (intentional in mock framework)
          rg --files -g "*.sh" | xargs shellcheck -x -e SC1091 -e SC2030 -e SC2031
      - name: shfmt
        run: shfmt -d -i 2 -ci scripts/**/*.sh install.sh .chezmoitemplates/**/*.sh

  lint-lua:
    name: Lint / Lua
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Cache Lua tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.luarocks
            ~/.cargo/bin/stylua
          key: lua-tools-${{ runner.os }}-v1
      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y lua5.1 luarocks
          luarocks install --local luacheck
          echo "$HOME/.luarocks/bin" >> $GITHUB_PATH
          if ! command -v stylua &>/dev/null; then
            cargo install stylua
          fi
      - name: Luacheck
        run: luacheck dot_config/nvim
      - name: Stylua
        run: ~/.cargo/bin/stylua --check dot_config/nvim

  # ============================================================================
  # STAGE 2: SECURITY (Parallel with lint)
  # ============================================================================
  security-secrets:
    name: Security / Secrets Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-links:
    name: Security / Link Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Lychee link checker
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --verbose --no-progress
            --exclude-path ./dot_config
            --exclude "localhost|127.0.0.1|example.com"
            --accept 200,204,301,302,403,429
            --max-retries 3 --timeout 30
            "**/*.md"
          fail: false

  # ============================================================================
  # STAGE 3: TEST (Matrix across platforms)
  # ============================================================================
  test:
    name: Test / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: Setup Chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin -t v${{ env.CHEZMOI_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Init & Dry Run
        run: |
          chezmoi init
          chezmoi apply --verbose --dry-run
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: logs-test-${{ matrix.os }}
          path: ~/.local/share/chezmoi/.log
          retention-days: 5

  test-docker:
    name: Test / Docker (${{ matrix.distro }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        distro: [ubuntu, debian]
    steps:
      - uses: actions/checkout@v4
      - name: Test in container
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}:/root/.local/share/chezmoi" ${{ matrix.distro }}:latest bash -c "
            set -euo pipefail
            export DEBIAN_FRONTEND=noninteractive
            export PATH=\"/root/.local/bin:\$PATH\"
            apt-get update && apt-get install -y --no-install-recommends git curl ca-certificates
            ln -s /root/.local/share/chezmoi /root/.dotfiles
            sh -c \"\$(curl -fsLS get.chezmoi.io)\" -- -t v${{ env.CHEZMOI_VERSION }} init --promptDefaults --no-tty --source /root/.local/share/chezmoi
            DOTFILES_NONINTERACTIVE=1 chezmoi apply --exclude=scripts --force --no-tty
            echo 'Chezmoi applied successfully'
          "

  test-unit:
    name: Test / Unit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        run: |
          chmod +x scripts/tests/framework/*.sh
          ./scripts/tests/framework/test_runner.sh
      - name: Integration tests
        run: RUN_INTEGRATION=1 ./scripts/tests/framework/test_runner.sh

  # ============================================================================
  # STAGE 4: QUALITY (Depends on lint + test passing)
  # ============================================================================
  quality-idempotency:
    name: Quality / Idempotency
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint-shell, test]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin -t v${{ env.CHEZMOI_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          mkdir -p "$HOME/.config/chezmoi"
          echo "sourceDir = \"$GITHUB_WORKSPACE\"" > "$HOME/.config/chezmoi/chezmoi.toml"
      - name: First apply
        run: chezmoi apply --exclude=scripts --verbose
      - name: Second apply (must be no-op)
        run: |
          OUTPUT=$(chezmoi apply --exclude=scripts --verbose 2>&1)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -E "^(create|modify|remove)" | grep -v ".DS_Store"; then
            echo "::error::Not idempotent - second apply made changes"
            exit 1
          fi

  quality-nix:
    name: Quality / Nix
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: [lint-shell]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v21
      - name: Flake check
        run: nix flake check ./nix

  # ============================================================================
  # STAGE 5: BENCHMARK (Only after tests pass)
  # ============================================================================
  benchmark:
    name: Benchmark / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y zsh hyperfine
          else
            brew install hyperfine
          fi
      - name: Setup Chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin -t v${{ env.CHEZMOI_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          mkdir -p "$HOME/.config/chezmoi"
          echo "sourceDir = \"$GITHUB_WORKSPACE\"" > "$HOME/.config/chezmoi/chezmoi.toml"
      - name: Apply dotfiles
        run: chezmoi apply --exclude=scripts
      - name: Performance benchmark
        run: |
          chmod +x scripts/tests/performance/*.sh
          ./scripts/tests/performance/benchmark_runner.sh || true
      - name: Shell startup threshold (500ms)
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            SHELL_CMD="zsh"
          else
            SHELL_CMD="/bin/zsh"
          fi
          time_ms=$(hyperfine --warmup 3 --runs 10 "$SHELL_CMD -i -c exit" --export-json /tmp/bench.json 2>/dev/null && jq '.results[0].mean * 1000 | floor' /tmp/bench.json)
          echo "Shell startup: ${time_ms}ms"
          if [[ ${time_ms:-0} -gt 500 ]]; then
            echo "::warning::Shell startup ${time_ms}ms exceeds 500ms target"
          fi
