name: CI

on:
  push:
    branches: [master]
    tags: ['v*.*.*']
    # Path filters: Only run when relevant files change
    paths:
      - '**.sh'
      - '**.tmpl'
      - '.chezmoitemplates/**'
      - 'dot_*/**'
      - 'install/**'
      - 'scripts/**'
      - 'nix/**'
      - '.github/workflows/ci.yml'
      - '!**.md'
      - '!docs/**'
  pull_request:
    branches: [master]
    paths:
      - '**.sh'
      - '**.tmpl'
      - '.chezmoitemplates/**'
      - 'dot_*/**'
      - 'install/**'
      - 'scripts/**'
      - 'nix/**'
      - '.github/workflows/ci.yml'
      - '!**.md'
      - '!docs/**'
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday 6 AM UTC
  # Allow manual trigger for full CI
  workflow_dispatch:

permissions:
  contents: read

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CHEZMOI_VERSION: "2.47.1"

jobs:
  # ============================================================================
  # Path Change Detection
  # ============================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      shell: ${{ steps.filter.outputs.shell }}
      lua: ${{ steps.filter.outputs.lua }}
      nix: ${{ steps.filter.outputs.nix }}
      config: ${{ steps.filter.outputs.config }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shell:
              - '**.sh'
              - '.chezmoitemplates/**/*.sh'
              - 'scripts/**'
              - 'install/**'
            lua:
              - 'dot_config/nvim/**'
              - '**.lua'
            nix:
              - 'nix/**'
              - '**.nix'
            config:
              - 'dot_*/**'
              - '.chezmoitemplates/**'
              - '**.tmpl'

  # ============================================================================
  # STAGE 1: LINT (Fast, parallel checks)
  # ============================================================================
  lint-shell:
    name: Lint / Shell
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.shell == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Cache tools
        uses: actions/cache@v4
        with:
          path: ~/.local/bin
          key: shell-tools-${{ runner.os }}-v2
      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck ripgrep
          if ! command -v shfmt &>/dev/null; then
            curl -sS https://webi.sh/shfmt | sh
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Shellcheck
        run: |
          # Exclude info-level warnings that are false positives
          # SC1091: Not following sourced files (expected, files don't exist in CI)
          # SC2030: Modification of VAR is local (intentional in test subshells)
          # SC2031: VAR was modified in a subshell (intentional in mock framework)
          rg --files -g "*.sh" | xargs shellcheck -x -e SC1091 -e SC2030 -e SC2031
      - name: shfmt
        run: shfmt -d -i 2 -ci scripts/**/*.sh install.sh .chezmoitemplates/**/*.sh

  lint-lua:
    name: Lint / Lua
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.lua == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Cache Lua tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.luarocks
            ~/.cargo/bin/stylua
          key: lua-tools-${{ runner.os }}-v2
      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y lua5.1 luarocks
          luarocks install --local luacheck
          echo "$HOME/.luarocks/bin" >> $GITHUB_PATH
          if ! command -v stylua &>/dev/null; then
            cargo install stylua
          fi
      - name: Luacheck
        run: luacheck dot_config/nvim
      - name: Stylua
        run: ~/.cargo/bin/stylua --check dot_config/nvim

  # ============================================================================
  # STAGE 2: SECURITY (Parallel with lint)
  # ============================================================================
  security-secrets:
    name: Security / Secrets Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Always run secrets scan on PRs and pushes
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-links:
    name: Security / Link Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run link check on schedule or manual trigger (saves minutes)
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Lychee link checker
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --verbose --no-progress
            --exclude-path ./dot_config
            --exclude "localhost|127.0.0.1|example.com"
            --accept 200,204,301,302,403,429
            --max-retries 3 --timeout 30
            "**/*.md"
          fail: false

  # ============================================================================
  # STAGE 3: TEST (Optimized matrix)
  # ============================================================================
  test:
    name: Test / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.config == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        # Linux-only for PRs (cheapest), full matrix on schedule/manual
        os: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' && fromJSON('["ubuntu-latest", "macos-latest"]') || fromJSON('["ubuntu-latest"]') }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: Cache Chezmoi
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/chezmoi
          key: chezmoi-${{ runner.os }}-${{ env.CHEZMOI_VERSION }}
      - name: Setup Chezmoi
        run: |
          if [[ ! -x "$HOME/.local/bin/chezmoi" ]]; then
            sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin -t v${{ env.CHEZMOI_VERSION }}
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Init & Dry Run
        run: |
          chezmoi init
          chezmoi apply --verbose --dry-run
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-test-${{ matrix.os }}
          path: ~/.local/share/chezmoi/.log
          retention-days: 5

  test-docker:
    name: Test / Docker (${{ matrix.distro }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    # Only run Docker tests on schedule or when install scripts change
    if: (needs.changes.outputs.shell == 'true' && needs.changes.outputs.config == 'true') || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        distro: [ubuntu]  # Reduced from [ubuntu, debian] - debian is similar
    steps:
      - uses: actions/checkout@v4
      - name: Test in container
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}:/root/.local/share/chezmoi" ${{ matrix.distro }}:latest bash -c "
            set -euo pipefail
            export DEBIAN_FRONTEND=noninteractive
            export PATH=\"/root/.local/bin:\$PATH\"
            apt-get update && apt-get install -y --no-install-recommends git curl ca-certificates
            ln -s /root/.local/share/chezmoi /root/.dotfiles
            sh -c \"\$(curl -fsLS get.chezmoi.io)\" -- -t v${{ env.CHEZMOI_VERSION }} init --promptDefaults --no-tty --source /root/.local/share/chezmoi
            DOTFILES_NONINTERACTIVE=1 chezmoi apply --exclude=scripts --force --no-tty
            echo 'Chezmoi applied successfully'
          "

  test-unit:
    name: Test / Unit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.shell == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        run: |
          chmod +x scripts/tests/framework/*.sh
          ./scripts/tests/framework/test_runner.sh
      - name: Integration tests
        run: RUN_INTEGRATION=1 ./scripts/tests/framework/test_runner.sh

  # ============================================================================
  # STAGE 4: QUALITY (Depends on lint + test passing)
  # ============================================================================
  quality-idempotency:
    name: Quality / Idempotency
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint-shell, test]
    # Only run on full CI (schedule/manual) - idempotency is expensive
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin -t v${{ env.CHEZMOI_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          mkdir -p "$HOME/.config/chezmoi"
          echo "sourceDir = \"$GITHUB_WORKSPACE\"" > "$HOME/.config/chezmoi/chezmoi.toml"
      - name: First apply
        run: chezmoi apply --exclude=scripts --verbose
      - name: Second apply (must be no-op)
        run: |
          OUTPUT=$(chezmoi apply --exclude=scripts --verbose 2>&1)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -E "^(create|modify|remove)" | grep -v ".DS_Store"; then
            echo "::error::Not idempotent - second apply made changes"
            exit 1
          fi

  quality-nix:
    name: Quality / Nix
    runs-on: ubuntu-latest  # Linux only - saves expensive macOS minutes
    timeout-minutes: 15
    needs: [changes]
    if: needs.changes.outputs.nix == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: DeterminateSystems/magic-nix-cache-action@v8
      - name: Flake check
        run: nix flake check ./nix

  # ============================================================================
  # STAGE 5: BENCHMARK (Only on schedule/manual - expensive)
  # ============================================================================
  benchmark:
    name: Benchmark / Linux
    runs-on: ubuntu-latest  # Linux only - cheaper than multi-OS
    timeout-minutes: 10
    needs: [test]
    # Only run benchmarks on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y zsh hyperfine jq

      - name: Setup Chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin -t v${{ env.CHEZMOI_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          mkdir -p "$HOME/.config/chezmoi"
          echo "sourceDir = \"$GITHUB_WORKSPACE\"" > "$HOME/.config/chezmoi/chezmoi.toml"

      - name: Apply dotfiles
        run: chezmoi apply --exclude=scripts

      - name: Performance benchmark
        run: |
          chmod +x scripts/tests/performance/*.sh 2>/dev/null || true
          ./scripts/tests/performance/benchmark_runner.sh 2>/dev/null || true

      - name: Shell startup benchmark with regression tracking
        id: benchmark
        run: |
          mkdir -p benchmark-results

          # Run hyperfine benchmark
          hyperfine --warmup 3 --runs 10 "zsh -i -c exit" \
            --export-json benchmark-results/shell-startup.json \
            --export-markdown benchmark-results/shell-startup.md

          # Extract metrics
          time_ms=$(jq '.results[0].mean * 1000 | floor' benchmark-results/shell-startup.json)
          time_min=$(jq '.results[0].min * 1000 | floor' benchmark-results/shell-startup.json)
          time_max=$(jq '.results[0].max * 1000 | floor' benchmark-results/shell-startup.json)
          time_stddev=$(jq '.results[0].stddev * 1000 | floor' benchmark-results/shell-startup.json)

          echo "time_ms=$time_ms" >> $GITHUB_OUTPUT
          echo "time_min=$time_min" >> $GITHUB_OUTPUT
          echo "time_max=$time_max" >> $GITHUB_OUTPUT

          # Create regression tracking record
          cat > benchmark-results/metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "shell_startup": {
              "mean_ms": $time_ms,
              "min_ms": $time_min,
              "max_ms": $time_max,
              "stddev_ms": $time_stddev,
              "threshold_ms": 500,
              "passed": $([ $time_ms -le 500 ] && echo true || echo false)
            }
          }
          EOF

          echo "### Shell Startup Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mean | ${time_ms}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Min | ${time_min}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Max | ${time_max}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Std Dev | ${time_stddev}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | 500ms |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ $time_ms -gt 500 ]]; then
            echo "::warning::Shell startup ${time_ms}ms exceeds 500ms target"
            echo "⚠️ **Performance regression detected**: ${time_ms}ms exceeds 500ms threshold" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Performance OK**: ${time_ms}ms is within 500ms threshold" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: benchmark-results/
          retention-days: 90

      - name: Comment on PR with benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const time_ms = '${{ steps.benchmark.outputs.time_ms }}';
            const threshold = 500;
            const status = parseInt(time_ms) <= threshold ? '✅' : '⚠️';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${status} Shell Performance Benchmark

              | Metric | Value |
              |--------|-------|
              | Startup Time | ${time_ms}ms |
              | Threshold | ${threshold}ms |
              | Status | ${parseInt(time_ms) <= threshold ? 'Passed' : 'Regression detected'} |

              <details>
              <summary>Benchmark Details</summary>

              - Min: ${{ steps.benchmark.outputs.time_min }}ms
              - Max: ${{ steps.benchmark.outputs.time_max }}ms
              - Commit: ${{ github.sha }}
              </details>`
            })
