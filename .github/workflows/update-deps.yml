name: Update Dependencies

on:
  schedule:
    - cron: '0 8 * * 1'  # Weekly on Monday at 8 AM UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no PR created)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  BRANCH_NAME: deps/auto-update-${{ github.run_number }}

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install tools
        run: |
          # Install jq, yq, and other tools
          sudo apt-get update && sudo apt-get install -y jq curl

          # Install yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Check for updates
        id: updates
        run: |
          UPDATES=""

          # Check Nerd Fonts version
          echo "Checking Nerd Fonts..."
          LATEST_NF=$(curl -s https://api.github.com/repos/ryanoasis/nerd-fonts/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          CURRENT_NF=$(grep -oP 'NERD_FONTS_VERSION="\K[^"]+' install/provision/run_onchange_50-install-fonts.sh.tmpl 2>/dev/null || echo "unknown")
          if [[ "$LATEST_NF" != "$CURRENT_NF" && "$LATEST_NF" != "null" ]]; then
            UPDATES="${UPDATES}nerd-fonts: ${CURRENT_NF} -> ${LATEST_NF}\n"
            echo "nerd_fonts_update=true" >> $GITHUB_OUTPUT
            echo "nerd_fonts_version=$LATEST_NF" >> $GITHUB_OUTPUT
          fi

          # Check chezmoi version in CI
          echo "Checking Chezmoi..."
          LATEST_CM=$(curl -s https://api.github.com/repos/twpayne/chezmoi/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          CURRENT_CM=$(grep -oP 'CHEZMOI_VERSION: "\K[^"]+' .github/workflows/ci.yml 2>/dev/null || echo "unknown")
          if [[ "$LATEST_CM" != "$CURRENT_CM" && "$LATEST_CM" != "null" ]]; then
            UPDATES="${UPDATES}chezmoi: ${CURRENT_CM} -> ${LATEST_CM}\n"
            echo "chezmoi_update=true" >> $GITHUB_OUTPUT
            echo "chezmoi_version=$LATEST_CM" >> $GITHUB_OUTPUT
          fi

          # Check GitHub Actions versions
          echo "Checking GitHub Actions..."
          for action in "actions/checkout" "actions/upload-artifact" "actions/cache"; do
            name=$(echo "$action" | cut -d'/' -f2)
            current=$(grep -oP "${action}@v\K[0-9]+" .github/workflows/*.yml 2>/dev/null | sort -u | head -1 || echo "unknown")
            latest=$(curl -s "https://api.github.com/repos/${action}/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
            if [[ "$latest" != "$current" && "$latest" != "null" && -n "$current" ]]; then
              UPDATES="${UPDATES}${name}: v${current} -> v${latest}\n"
            fi
          done

          if [[ -n "$UPDATES" ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo -e "Updates found:\n$UPDATES"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates found"
          fi

      - name: Apply updates
        if: steps.updates.outputs.has_updates == 'true' && inputs.dry_run != 'true'
        run: |
          # Update Nerd Fonts version
          if [[ "${{ steps.updates.outputs.nerd_fonts_update }}" == "true" ]]; then
            VERSION="${{ steps.updates.outputs.nerd_fonts_version }}"
            sed -i "s/NERD_FONTS_VERSION=\"[^\"]*\"/NERD_FONTS_VERSION=\"${VERSION}\"/" install/provision/run_onchange_50-install-fonts.sh.tmpl
            sed -i "s|nerd-fonts/releases/download/v[0-9.]*|nerd-fonts/releases/download/v${VERSION}|g" docs/FONTS.md
          fi

          # Update Chezmoi version in CI
          if [[ "${{ steps.updates.outputs.chezmoi_update }}" == "true" ]]; then
            VERSION="${{ steps.updates.outputs.chezmoi_version }}"
            sed -i "s/CHEZMOI_VERSION: \"[^\"]*\"/CHEZMOI_VERSION: \"${VERSION}\"/" .github/workflows/ci.yml
          fi

      - name: Create Pull Request
        if: steps.updates.outputs.has_updates == 'true' && inputs.dry_run != 'true'
        run: |
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "chore(deps): automated dependency updates

          Updates detected and applied:
          ${{ steps.updates.outputs.updates_summary }}

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "chore(deps): automated dependency updates" \
            --body "## Automated Dependency Updates

          This PR was automatically generated by the dependency update workflow.

          ### Changes
          - Updated tool versions to latest releases
          - Updated GitHub Actions to latest versions

          ### Verification
          - [ ] CI passes
          - [ ] Shell startup time within threshold
          - [ ] Manual smoke test

          ---
          ðŸ¤– Generated automatically by [Update Dependencies](.github/workflows/update-deps.yml)" \
            --base master \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-neovim-plugins:
    name: Update Neovim Plugins
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Update lazy.nvim lockfile
        run: |
          # Create minimal init for headless update
          mkdir -p ~/.config/nvim
          cp -r dot_config/nvim/* ~/.config/nvim/ 2>/dev/null || true

          # Run lazy update (if lazy.nvim is set up)
          nvim --headless "+Lazy! sync" +qa 2>/dev/null || echo "Lazy.nvim sync skipped"

          # Check for lockfile changes
          if [[ -f ~/.config/nvim/lazy-lock.json ]]; then
            cp ~/.config/nvim/lazy-lock.json dot_config/nvim/lazy-lock.json 2>/dev/null || true
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet dot_config/nvim/lazy-lock.json 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit plugin updates
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "deps/nvim-plugins-${{ github.run_number }}"
          git add dot_config/nvim/lazy-lock.json
          git commit -m "chore(nvim): update lazy.nvim plugin lockfile"
          git push origin "deps/nvim-plugins-${{ github.run_number }}"

          gh pr create \
            --title "chore(nvim): update plugin versions" \
            --body "Automated Neovim plugin update via lazy.nvim" \
            --base master
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
