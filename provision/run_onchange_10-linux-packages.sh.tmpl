#!/usr/bin/env bash

# run_onchange_linux_install-packages.sh.tmpl
{{- if eq .chezmoi.os "linux" -}}

# Strict error handling
set -euo pipefail

log_info() { echo -e "\n[INFO] $*"; }
log_error() { echo -e "\n[ERROR] $*" >&2; }

log_info "üêß Linux: Starting setup..."

if command -v apt-get >/dev/null; then
  log_info "Updating packages..."
  
  # Check if we have sudo or if we're root
  sudo_cmd=""
  if command -v sudo >/dev/null; then
    sudo_cmd="sudo"
  elif [ "$(id -u)" -ne 0 ]; then
    log_error "This script requires root privileges or sudo."
    exit 1
  fi

  $sudo_cmd apt-get update
  # Add your packages here
  packages=(
    curl
    git
    zsh
    unzip
    fontconfig
    build-essential
    ripgrep
    fd-find
    bat
    jq
    yq
  )
  $sudo_cmd apt-get install -y "${packages[@]}"
fi

# Install Starship
if ! command -v starship >/dev/null; then
  log_info "Installing Starship..."
  curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# Install Zoxide
if ! command -v zoxide >/dev/null; then
  log_info "Installing Zoxide..."
  curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
fi

# Install FZF
if ! command -v fzf >/dev/null; then
  log_info "Installing FZF..."
  git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
  ~/.fzf/install --all
fi

# Install Neovim (Nightly)
if ! command -v nvim >/dev/null; then
  log_info "Installing Neovim (Nightly)..."
  curl -LO https://github.com/neovim/neovim/releases/download/nightly/nvim-linux64.tar.gz
  tar xzvf nvim-linux64.tar.gz
  sudo mv nvim-linux64 /opt/
  sudo ln -sf /opt/nvim-linux64/bin/nvim /usr/local/bin/nvim
  rm nvim-linux64.tar.gz
fi

# Install Lazygit
if ! command -v lazygit >/dev/null; then
  log_info "Installing Lazygit..."
  LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
  curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
  tar xf lazygit.tar.gz lazygit
  sudo install lazygit /usr/local/bin
  rm lazygit.tar.gz lazygit
fi

# Install Atuin (Shell History)
if ! command -v atuin >/dev/null; then
  log_info "Installing Atuin..."
  curl --proto '=https' --tlsv1.2 -sSf https://setup.atuin.sh | sh
fi

# Install Zellij (Multiplexer)
if ! command -v zellij >/dev/null; then
  log_info "Installing Zellij..."
  mkdir -p ~/.local/bin
  curl -L https://github.com/zellij-org/zellij/releases/latest/download/zellij-x86_64-unknown-linux-musl.tar.gz | tar xz -C ~/.local/bin zellij
fi

# Install Delta
if ! command -v delta >/dev/null; then
  log_info "Installing Delta..."
  cargo install git-delta
fi

# Install UV
if ! command -v uv >/dev/null; then
  log_info "Installing UV..."
  curl -LsSf https://astral.sh/uv/install.sh | sh
fi

# Install Yazi (File Manager)
if ! command -v yazi >/dev/null; then
  log_info "Installing Yazi..."
  # Use a helper script or direct binary (simplified for reliability)
  # Note: Yazi often requires a recent Rust toolchain or compiled binary.
  # For now, we will skip auto-install on Linux if not present to avoid breakage, 
  # as it has complex dependencies. Providing a hint instead.
  log_info "Note: To install Yazi on Linux, use cargo: cargo install --locked yazi-fm"
fi

# Install Ghostty (Visual Layer)
if ! command -v ghostty >/dev/null; then
    log_info "Installing Ghostty..."
    # Ghostty on Linux currently requires building from source or specific deb/rpm.
    # For now, we point to the official guide to avoid breaking CI with a heavy build.
    log_info "‚ö†Ô∏è Ghostty on Linux requires manual install or 'zig build'. See https://ghostty.org/docs/install/linux"
fi

log_info "üêß Linux: Setup complete."
{{- end -}}
