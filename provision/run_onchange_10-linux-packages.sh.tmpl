#!/usr/bin/env bash

# run_onchange_linux_install-packages.sh.tmpl
{{- if eq .chezmoi.os "linux" -}}

# Strict error handling
set -euo pipefail

log_info() { echo -e "\n[INFO] $*"; }
log_error() { echo -e "\n[ERROR] $*" >&2; }

log_info "üêß Linux: Starting setup..."

if command -v apt-get >/dev/null; then
  log_info "Updating packages..."
  
  # Check if we have sudo or if we're root
  sudo_cmd=""
  if command -v sudo >/dev/null; then
    sudo_cmd="sudo"
  elif [ "$(id -u)" -ne 0 ]; then
    log_error "This script requires root privileges or sudo."
    exit 1
  fi

  $sudo_cmd apt-get update
  # Add your packages here
  packages=(
    curl
    git
    zsh
    unzip
    fontconfig
  )
  $sudo_cmd apt-get install -y "${packages[@]}"
fi

# Install Atuin (Shell History)
if ! command -v atuin >/dev/null; then
  log_info "Installing Atuin..."
  curl --proto '=https' --tlsv1.2 -sSf https://setup.atuin.sh | sh
fi

# Install Zellij (Multiplexer)
if ! command -v zellij >/dev/null; then
  log_info "Installing Zellij..."
  mkdir -p ~/.local/bin
  curl -L https://github.com/zellij-org/zellij/releases/latest/download/zellij-x86_64-unknown-linux-musl.tar.gz | tar xz -C ~/.local/bin zellij
fi

# Install Yazi (File Manager)
if ! command -v yazi >/dev/null; then
  log_info "Installing Yazi..."
  # Use a helper script or direct binary (simplified for reliability)
  # Note: Yazi often requires a recent Rust toolchain or compiled binary.
  # For now, we will skip auto-install on Linux if not present to avoid breakage, 
  # as it has complex dependencies. Providing a hint instead.
  log_info "Note: To install Yazi on Linux, use cargo: cargo install --locked yazi-fm"
fi

log_info "üêß Linux: Setup complete."
{{- end -}}
