#!/usr/bin/env bash
set -euo pipefail

while read -r local_ref local_sha remote_ref remote_sha; do
  [ "$local_sha" = "0000000000000000000000000000000000000000" ] && continue

  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    range="$local_sha"
  elif git cat-file -e "${remote_sha}^{commit}" 2>/dev/null; then
    range="$remote_sha..$local_sha"
  else
    # Remote tip is not in the local object store yet (push without prior fetch).
    # Fall back to checking commits reachable from local tip.
    range="$local_sha"
  fi

  for c in $(git rev-list "$range"); do
    if ! git verify-commit "$c" >/dev/null 2>&1; then
      echo "Blocked: unsigned commit $c"
      exit 1
    fi
  done
done
