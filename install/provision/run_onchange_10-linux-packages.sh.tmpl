#!/usr/bin/env bash

# run_onchange_linux_install-packages.sh.tmpl
{{- if eq .chezmoi.os "linux" -}}

# Strict error handling
set -euo pipefail

# Source shared libraries
SCRIPT_DIR="{{ .chezmoi.sourceDir }}/install/lib"
# shellcheck source=install/lib/logging.sh
. "${SCRIPT_DIR}/logging.sh"
# shellcheck source=install/lib/installers.sh
. "${SCRIPT_DIR}/installers.sh"

log_info " Linux: Starting setup..."

if [ -f "$HOME/.config/dotfiles/versions.env" ]; then
  # shellcheck disable=SC1091
  . "$HOME/.config/dotfiles/versions.env"
fi

sudo_cmd="$(resolve_sudo)"

# ── Version Pins ──────────────────────────────────────────────
STARSHIP_TAG="${STARSHIP_TAG:-latest}"
ZOXIDE_TAG="${ZOXIDE_TAG:-latest}"
NEOVIM_TAG="${NEOVIM_TAG:-nightly}"
LAZYGIT_TAG="${LAZYGIT_TAG:-latest}"
ATUIN_TAG="${ATUIN_TAG:-latest}"
ZELLIJ_TAG="${ZELLIJ_TAG:-latest}"
UV_TAG="${UV_TAG:-latest}"
TOPGRADE_TAG="${TOPGRADE_TAG:-latest}"
MISE_TAG="${MISE_TAG:-latest}"
YAZI_TAG="${YAZI_TAG:-latest}"
AICHAT_TAG="${AICHAT_TAG:-latest}"
MODS_TAG="${MODS_TAG:-latest}"

warn_unpinned "Topgrade" "$TOPGRADE_TAG" "TOPGRADE_TAG"
warn_unpinned "Mise" "$MISE_TAG" "MISE_TAG"
warn_unpinned "Yazi" "$YAZI_TAG" "YAZI_TAG"
warn_unpinned "Starship" "$STARSHIP_TAG" "STARSHIP_TAG"
warn_unpinned "Zoxide" "$ZOXIDE_TAG" "ZOXIDE_TAG"
warn_unpinned "Neovim" "$NEOVIM_TAG" "NEOVIM_TAG"
warn_unpinned "Lazygit" "$LAZYGIT_TAG" "LAZYGIT_TAG"
warn_unpinned "Atuin" "$ATUIN_TAG" "ATUIN_TAG"
warn_unpinned "Zellij" "$ZELLIJ_TAG" "ZELLIJ_TAG"
warn_unpinned "UV" "$UV_TAG" "UV_TAG"
warn_unpinned "AIChat" "$AICHAT_TAG" "AICHAT_TAG"
warn_unpinned "Mods" "$MODS_TAG" "MODS_TAG"

# ── System Packages ──────────────────────────────────────────

if command -v apt-get >/dev/null; then
  log_info "Updating packages (apt)..."
  $sudo_cmd apt-get update
  packages=(
    curl git zsh unzip fontconfig build-essential
    ripgrep fd-find bat jq yq hyperfine fastfetch
    age podman lua5.1 luajit luarocks
    tmux pipx ruby ruby-dev gnupg
  )
  $sudo_cmd apt-get install -y "${packages[@]}"

  # GitHub CLI (apt) — requires official repo
  if ! command -v gh >/dev/null; then
    if ! apt-cache show gh >/dev/null 2>&1; then
      log_info "Adding GitHub CLI apt repository..."
      $sudo_cmd mkdir -p /etc/apt/keyrings
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | $sudo_cmd tee /etc/apt/keyrings/githubcli-archive-keyring.gpg >/dev/null
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        | $sudo_cmd tee /etc/apt/sources.list.d/github-cli.list >/dev/null
      $sudo_cmd apt-get update
    fi
    $sudo_cmd apt-get install -y gh || log_info "Skipping GitHub CLI install (apt)."
  fi

  optional_packages=(terraform terraform-docs tflint trivy packer vagrant ansible)
  install_optional=()
  for pkg in "${optional_packages[@]}"; do
    if apt-cache show "$pkg" >/dev/null 2>&1; then
      install_optional+=("$pkg")
    else
      log_info "Skipping optional package (apt): $pkg"
    fi
  done
  if [ ${#install_optional[@]} -gt 0 ]; then
    $sudo_cmd apt-get install -y "${install_optional[@]}"
  fi

elif command -v dnf >/dev/null; then
  log_info "Updating packages (dnf)..."
  packages=(
    curl git zsh unzip fontconfig gcc make
    ripgrep fd-find bat jq yq hyperfine fastfetch
    age podman lua luajit luarocks
    tmux pipx ruby ruby-devel gh gnupg2
  )
  $sudo_cmd dnf install -y "${packages[@]}"

  optional_packages=(terraform terraform-docs tflint trivy packer vagrant ansible)
  install_optional=()
  for pkg in "${optional_packages[@]}"; do
    if dnf list --available "$pkg" >/dev/null 2>&1; then
      install_optional+=("$pkg")
    else
      log_info "Skipping optional package (dnf): $pkg"
    fi
  done
  if [ ${#install_optional[@]} -gt 0 ]; then
    $sudo_cmd dnf install -y "${install_optional[@]}"
  fi

elif command -v pacman >/dev/null; then
  log_info "Updating packages (pacman)..."
  $sudo_cmd pacman -Syu --noconfirm
  packages=(
    curl git zsh unzip fontconfig base-devel
    ripgrep fd bat jq yq hyperfine fastfetch
    age podman lua luajit luarocks
    tmux pipx ruby github-cli gnupg
  )
  $sudo_cmd pacman -S --needed --noconfirm "${packages[@]}"

  optional_packages=(terraform terraform-docs tflint trivy packer vagrant ansible)
  install_optional=()
  for pkg in "${optional_packages[@]}"; do
    if pacman -Si "$pkg" >/dev/null 2>&1; then
      install_optional+=("$pkg")
    else
      log_info "Skipping optional package (pacman): $pkg"
    fi
  done
  if [ ${#install_optional[@]} -gt 0 ]; then
    $sudo_cmd pacman -S --needed --noconfirm "${install_optional[@]}"
  fi
fi

# ── Luacheck ─────────────────────────────────────────────────

if ! command -v luacheck >/dev/null; then
  if command -v luarocks >/dev/null; then
    log_info "Installing Luacheck via luarocks..."
    luarocks install --local luacheck || true
  else
    log_warn "Luacheck not found and luarocks is missing. Install manually."
  fi
fi

# ── Binary Tools (GitHub Releases) ───────────────────────────

arch="$(resolve_arch)"

# Starship
if ! command -v starship >/dev/null; then
  log_info "Installing Starship..."
  target="${arch}-unknown-linux-gnu"
  url="$(github_asset_url "starship/starship" "${target}.tar.gz" "$STARSHIP_TAG")"
  sha_url="$(github_asset_url "starship/starship" "${target}.tar.gz.sha256" "$STARSHIP_TAG")"
  install_from_tarball "$url" "$sha_url" "starship" "$HOME/.local/bin"
fi

# Zoxide
if ! command -v zoxide >/dev/null; then
  log_info "Installing Zoxide..."
  target="${arch}-unknown-linux-musl"
  url="$(github_asset_url "ajeetdsouza/zoxide" "${target}.tar.gz" "$ZOXIDE_TAG")"
  sha_url="$(github_asset_url "ajeetdsouza/zoxide" "${target}.tar.gz.sha256" "$ZOXIDE_TAG")"
  install_from_tarball "$url" "$sha_url" "zoxide" "$HOME/.local/bin"
fi

# FZF (git-based install)
if ! command -v fzf >/dev/null; then
  log_info "Installing FZF..."
  if [ -d "${HOME}/.fzf" ]; then
    if [ -x "${HOME}/.fzf/install" ]; then
      if [ -d "${HOME}/.fzf/.git" ]; then
        git -C "${HOME}/.fzf" pull --ff-only || true
      fi
      "${HOME}/.fzf/install" --all
    else
      log_warn "Existing ~/.fzf without install script; skipping FZF install."
    fi
  else
    git clone --depth 1 https://github.com/junegunn/fzf.git "${HOME}/.fzf"
    "${HOME}/.fzf/install" --all
  fi
fi

# Neovim (custom install to /opt)
if ! command -v nvim >/dev/null; then
  log_info "Installing Neovim (Nightly)..."
  neovim_sha_suffix="${NEOVIM_NIGHTLY_SHA_SUFFIX:-sha256sum}"
  url="$(github_asset_url "neovim/neovim" "nvim-linux64.tar.gz" "$NEOVIM_TAG")"
  sha_url="$(github_asset_url "neovim/neovim" "nvim-linux64.tar.gz.${neovim_sha_suffix}" "$NEOVIM_TAG")"
  tmp_dir="$(mktemp -d)"
  download_and_verify_sha256 "$url" "$sha_url" "$tmp_dir/nvim-linux64.tar.gz"
  tar -xzf "$tmp_dir/nvim-linux64.tar.gz" -C "$tmp_dir"
  $sudo_cmd rm -rf /opt/nvim-linux64
  $sudo_cmd mv "$tmp_dir/nvim-linux64" /opt/
  $sudo_cmd ln -sf /opt/nvim-linux64/bin/nvim /usr/local/bin/nvim
  rm -rf "$tmp_dir"
fi

# Lazygit (uses checksums.txt)
if ! command -v lazygit >/dev/null; then
  log_info "Installing Lazygit..."
  case "$arch" in
    x86_64)  target="Linux_x86_64" ;;
    aarch64) target="Linux_arm64" ;;
  esac
  url="$(github_asset_url "jesseduffield/lazygit" "lazygit_${target}.tar.gz" "$LAZYGIT_TAG")"
  sha_url="$(github_asset_url "jesseduffield/lazygit" "checksums.txt" "$LAZYGIT_TAG")"
  install_from_tarball_checksums "$url" "$sha_url" "lazygit" "$HOME/.local/bin"
fi

# Atuin
if ! command -v atuin >/dev/null; then
  log_info "Installing Atuin..."
  target="${arch}-unknown-linux-gnu"
  url="$(github_asset_url "atuinsh/atuin" "${target}.tar.gz" "$ATUIN_TAG")"
  sha_url="$(github_asset_url "atuinsh/atuin" "${target}.tar.gz.sha256" "$ATUIN_TAG")"
  install_from_tarball "$url" "$sha_url" "atuin" "$HOME/.local/bin"
fi

# Zellij
if ! command -v zellij >/dev/null; then
  log_info "Installing Zellij..."
  target="${arch}-unknown-linux-musl"
  url="$(github_asset_url "zellij-org/zellij" "${target}.tar.gz" "$ZELLIJ_TAG")"
  sha_url="$(github_asset_url "zellij-org/zellij" "${target}.tar.gz.sha256" "$ZELLIJ_TAG")"
  install_from_tarball "$url" "$sha_url" "zellij" "$HOME/.local/bin"
fi

# ── Rust Toolchain ───────────────────────────────────────────

if ! command -v rustup >/dev/null; then
  log_info "Installing Rustup..."
  curl -fsSL https://sh.rustup.rs | sh -s -- -y --no-modify-path
  # shellcheck disable=SC1091
  . "${HOME}/.cargo/env"
fi

if command -v cargo >/dev/null; then
  if ! cargo install --list 2>/dev/null | grep -q "^cargo-update "; then
    log_info "Installing cargo-install-update..."
    cargo install cargo-update || true
  fi
fi

if ! command -v stylua >/dev/null; then
  if command -v cargo >/dev/null; then
    log_info "Installing Stylua via cargo..."
    cargo install stylua || true
  else
    log_warn "Stylua not found and cargo is missing. Install stylua manually."
  fi
fi

if ! command -v delta >/dev/null; then
  if command -v cargo >/dev/null; then
    log_info "Installing Delta via cargo..."
    cargo install git-delta
  else
    log_info "Skipping Delta install: cargo not found."
  fi
fi

# ── Python/Go/AI Tools ──────────────────────────────────────

# UV
if ! command -v uv >/dev/null; then
  log_info "Installing UV..."
  target="${arch}-unknown-linux-gnu"
  url="$(github_asset_url "astral-sh/uv" "${target}.tar.gz" "$UV_TAG")"
  sha_url="$(github_asset_url "astral-sh/uv" "${target}.tar.gz.sha256" "$UV_TAG")"
  tmp_dir="$(mktemp -d)"
  download_and_verify_sha256 "$url" "$sha_url" "$tmp_dir/uv.tar.gz"
  tar -xzf "$tmp_dir/uv.tar.gz" -C "$tmp_dir"
  mkdir -p "$HOME/.local/bin"
  find "$tmp_dir" -type f \( -name "uv" -o -name "uvx" \) -perm -u+x -exec install -m 0755 {} "$HOME/.local/bin/" \;
  rm -rf "$tmp_dir"
fi

# Topgrade
if ! command -v topgrade >/dev/null; then
  log_info "Installing Topgrade..."
  target="${arch}-unknown-linux-gnu"
  tag_num="${TOPGRADE_TAG#v}"
  url="$(github_asset_url "topgrade-rs/topgrade" "topgrade-${tag_num}-${target}.tar.gz" "$TOPGRADE_TAG")"
  sha_url="$(github_asset_url "topgrade-rs/topgrade" "topgrade-${tag_num}-${target}.tar.gz.sha256" "$TOPGRADE_TAG")"
  install_from_tarball "$url" "$sha_url" "topgrade" "$HOME/.local/bin"
fi

# Mise
if ! command -v mise >/dev/null; then
  log_info "Installing Mise..."
  case "$arch" in
    x86_64)  target="x64" ;;
    aarch64) target="arm64" ;;
  esac
  url="$(github_asset_url "jdx/mise" "mise-${MISE_TAG}-linux-${target}.tar.gz" "$MISE_TAG")"
  sha_url="$(github_asset_url "jdx/mise" "SHASUMS" "$MISE_TAG")"
  install_from_tarball_checksums "$url" "$sha_url" "mise" "$HOME/.local/bin"
fi

# Yazi (zip archive with two binaries)
if ! command -v yazi >/dev/null; then
  log_info "Installing Yazi..."
  target="${arch}-unknown-linux-gnu"
  url="$(github_asset_url "sxyazi/yazi" "yazi-${target}.zip" "$YAZI_TAG")"
  sha_url="$(github_asset_url "sxyazi/yazi" "yazi-${target}.zip.sha256" "$YAZI_TAG")"
  install_from_zip "$url" "$sha_url" "$HOME/.local/bin" "yazi" "ya"
fi

# AIChat
if ! command -v aichat >/dev/null; then
  log_info "Installing AIChat..."
  target="${arch}-unknown-linux-musl"
  url="$(github_asset_url "sigoden/aichat" "aichat-${AICHAT_TAG}-${target}.tar.gz" "$AICHAT_TAG")"
  sha_url="${url}.sha256"
  install_from_tarball "$url" "$sha_url" "aichat" "$HOME/.local/bin"
fi

# Mods (uses checksums.txt)
if ! command -v mods >/dev/null; then
  log_info "Installing Mods..."
  case "$arch" in
    x86_64)  target="Linux_x86_64" ;;
    aarch64) target="Linux_arm64" ;;
  esac
  url="$(github_asset_url "charmbracelet/mods" "mods_${MODS_TAG}_${target}.tar.gz" "$MODS_TAG")"
  sha_url="$(github_asset_url "charmbracelet/mods" "checksums.txt" "$MODS_TAG")"
  install_from_tarball_checksums "$url" "$sha_url" "mods" "$HOME/.local/bin"
fi

# Aider (Python-based)
if ! command -v aider >/dev/null; then
  log_info "Installing Aider..."
  if command -v uv >/dev/null; then
    uv tool install aider-chat || log_warn "Aider install via uv failed. Install manually with: pip install aider-chat"
  elif command -v pip3 >/dev/null; then
    python3 -m pip install --user aider-chat || log_warn "Aider install via pip failed."
  else
    log_info "Skipping Aider install: neither uv nor pip found."
  fi
fi

# Ghostty (manual install required on Linux)
if ! command -v ghostty >/dev/null; then
  log_info "Ghostty on Linux requires manual install. See https://ghostty.org/docs/install/linux"
fi

log_info " Linux: Setup complete."
{{- end -}}
