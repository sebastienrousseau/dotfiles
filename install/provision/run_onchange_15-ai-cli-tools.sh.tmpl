#!/usr/bin/env bash

# run_onchange_15-ai-cli-tools.sh.tmpl
{{- if eq .chezmoi.os "linux" -}}

# Strict error handling
set -euo pipefail

log_info() { echo -e "\\n[INFO] $*"; }
log_error() { echo -e "\\n[ERROR] $*" >&2; }

log_info "ðŸ¤– Installing AI CLI tools via npm..."

# Ensure fnm is available
if ! command -v fnm >/dev/null 2>&1; then
  log_info "fnm not found. Installing fnm..."
  curl -fsSL https://fnm.vercel.app/install | bash
fi

# Load fnm environment (try multiple locations)
if [ -d "$HOME/.local/share/fnm" ]; then
  export PATH="$HOME/.local/share/fnm:$PATH"
fi

if command -v fnm >/dev/null 2>&1; then
  eval "$(fnm env --use-on-cd 2>/dev/null || fnm env 2>/dev/null || true)"
else
  log_error "fnm installation failed. Please install manually."
  exit 1
fi

# Ensure Node.js is installed
if ! command -v node >/dev/null 2>&1; then
  log_info "Installing Node.js v24 via fnm..."
  fnm install 24 || fnm install --lts
  fnm default 24 2>/dev/null || fnm default lts-latest 2>/dev/null || true
  fnm use 24 2>/dev/null || fnm use lts-latest 2>/dev/null || true
  eval "$(fnm env 2>/dev/null || true)"
fi

if command -v corepack >/dev/null 2>&1; then
  corepack enable || true
fi

log_info "Node.js version: $(node --version)"
log_info "npm version: $(npm --version)"

# Install AI CLI tools globally
AI_TOOLS=(
  "@anthropic-ai/claude-code"
  "@google/gemini-cli"
  "@openai/codex"
  "opencode-ai"
  "@factory/cli"
)

# Install development tools globally
DEV_TOOLS=(
  "eslint_d"
  "prettier_d"
  "typescript"
  "typescript-language-server"
)

for tool in "${AI_TOOLS[@]}"; do
  log_info "Installing $tool..."
  npm install -g "$tool" 2>&1 || log_error "Failed to install $tool (continuing...)"
done

log_info "ðŸ› ï¸ Installing development tools via npm..."

for tool in "${DEV_TOOLS[@]}"; do
  log_info "Installing $tool..."
  npm install -g "$tool" 2>&1 || log_error "Failed to install $tool (continuing...)"
done

log_info "âœ… AI CLI and dev tools installation complete!"
log_info ""
log_info "Available commands:"
log_info "  AI Tools:"
log_info "    - claude   (Anthropic Claude CLI)"
log_info "    - gemini   (Google Gemini CLI)"
log_info "    - codex    (OpenAI Codex CLI)"
log_info "    - opencode (OpenCode AI)"
log_info "    - droid    (Factory AI Droid)"
log_info "  Dev Tools:"
log_info "    - eslint_d   (ESLint daemon for fast linting)"
log_info "    - prettier_d (Prettier daemon for fast formatting)"
log_info "    - tsserver   (TypeScript language server)"
log_info ""
log_info "Note: You may need to restart your shell or run 'eval \"\$(fnm env)\"'"

{{- end -}}
