#!/usr/bin/env bash

# run_onchange_darwin_install-packages.sh.tmpl
{{- if eq .chezmoi.os "darwin" -}}

# Strict error handling
set -euo pipefail

log_info() { echo -e "\n[INFO] $*"; }
log_error() { echo -e "\n[ERROR] $*" >&2; }

log_info " macOS: Starting setup..."

# Check Homebrew
if ! command -v brew >/dev/null; then
  log_info "Homebrew not found. Installing..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Brewfile hash: {{ printf "%s%s" (include "dot_config/shell/Brewfile.cli") (include "dot_config/shell/Brewfile.cask") | sha256sum }}
if [ -f "$HOME/.config/shell/Brewfile.cli" ]; then
  log_info "Installing CLI packages from Brewfile.cli..."
  brew bundle --file="$HOME/.config/shell/Brewfile.cli"
else
  log_error "Brewfile.cli not found."
fi

if [ -f "$HOME/.config/shell/Brewfile.cask" ]; then
  log_info "Installing GUI packages from Brewfile.cask..."
  brew bundle --file="$HOME/.config/shell/Brewfile.cask"
else
  log_error "Brewfile.cask not found."
fi

log_info " macOS: Setup complete."
{{- end -}}
